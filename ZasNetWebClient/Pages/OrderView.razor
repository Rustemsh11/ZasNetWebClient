@page "/order/{OrderId:int?}"
@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using ZasNetWebClient.Components
@inject ApiService ApiService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>@(IsEditMode ? $"Заявка #{OrderId}" : "Создание заявки - ZasNet")</PageTitle>

    <div class="page-header-compact">
        <h1>@(IsEditMode ? $"Заявка #{OrderId}" : "Создание новой заявки")</h1>
    </div>

    <div class="create-form-container-compact">
        <EditForm Model="@orderModel" OnValidSubmit="@HandleSave">
            <DataAnnotationsValidator />
            
            <div class="form-section">
                <h3>Информация клиента</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client">Название клиента</label>
                        <InputText id="client" @bind-Value="orderModel.Client" class="form-control" placeholder="введите клиента" />
                        <ValidationMessage For="@(() => orderModel.Client)" />
                    </div>
                    <div class="form-group">
                        <label for="date">Дата</label>
                        <input type="datetime-local" id="date" @bind="orderModel.Date" class="form-control" />
                        <ValidationMessage For="@(() => orderModel.Date)" />
                    </div>
                    <div class="form-group">
                        <label for="payment">Вид оплаты</label>
                        <InputSelect id="payment" @bind-Value="orderModel.PaymentType" class="form-control">
                            <option value="@PaymentType.Cash">Наличные</option>
                            <option value="@PaymentType.Card">Карта</option>
                            <option value="@PaymentType.Electronic">СБП</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => orderModel.PaymentType)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="clientType">Тип клиента</label>
                        <InputSelect id="clientType" @bind-Value="orderModel.ClientType" class="form-control">
                            <option value="@ClientType.FizNal">Физ. лицо нал.</option>
                        <option value="@ClientType.LegalWithVat">Юр. лицо с НДС</option>
                        <option value="@ClientType.LegalWithoutVat">Юр. лицо без НДС</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => orderModel.ClientType)" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">Город</label>
                        <InputText id="city" @bind-Value="orderModel.AddressCity" class="form-control" placeholder="введите город"/>
                        <ValidationMessage For="@(() => orderModel.AddressCity)" />
                    </div>
                    <div class="form-group">
                        <label for="street">Улица</label>
                        <InputText id="street" @bind-Value="orderModel.AddressStreet" class="form-control" placeholder="введите улицу" />
                        <ValidationMessage For="@(() => orderModel.AddressStreet)" />
                    </div>
                    <div class="form-group">
                        <label for="number">Номер дома</label>
                        <InputText id="number" @bind-Value="orderModel.AddressNumber" class="form-control" placeholder="введите номер дома" />
                        <ValidationMessage For="@(() => orderModel.AddressNumber)" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Доп. информация</label>
                    <InputTextArea id="description" @bind-Value="orderModel.Description" class="form-control" placeholder="введите доп. информацию" rows="1" />
                </div>
            </div>

            <div class="form-section">
                <h3>Информация заявки</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Общая стоимость заявки</label>
                        <InputNumber id="price" @bind-Value="orderModel.OrderPriceAmount" class="form-control" />
                    <ValidationMessage For="@(() => orderModel.OrderPriceAmount)" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <div class="services-header">
                            <label>Ответственный сотрудник</label>
                            <button type="button" class="btn-primary" @onclick="ShowEmployeeDialog">
                                <span>+</span> Выбрать
                            </button>
                        </div>
                        <div class="selection-container">
                            @if (orderModel.OrderEmployeeDtos.Any())
                            {
                                <div class="selected-items">
                                    @foreach (var orderEmployee in orderModel.OrderEmployeeDtos)
                                    {
                                        if(orderEmployee != null)
                                        {
                                            <span class="selected-item">
                                                @orderEmployee.Name
                                                <button type="button" class="btn-remove-item" @onclick="() => RemoveEmployee(orderEmployee)">&times;</button>
                                            </span>
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-selection">Работники не выбраны</div>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="services-header">
                            <label>Выездные машины</label>
                            <button type="button" class="btn-primary" @onclick="ShowCarDialog">
                                <span>+</span> Выбрать
                            </button>
                        </div>
                        <div class="selection-container">
                            @if (orderModel.OrderCarDtos.Any())
                            {
                                <div class="selected-items">
                                    @foreach (var car in orderModel.OrderCarDtos)
                                    {
                                        if (car != null)
                                        {
                                            <span class="selected-item">
                                                @car.Name
                                                <button type="button" class="btn-remove-item" @onclick="() => RemoveCar(car)">&times;</button>
                                            </span>
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-selection">Машины не выбраны</div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="services-header">
                    <h3>Услуги</h3>
                    <button type="button" class="btn-primary" @onclick="ShowServiceDialog">
                        <span>+</span> Добавить
                    </button>
                </div>
                
                @if (orderModel.OrderServicesDtos.Any())
                {
                    <table class="services-table">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Цена</th>
                                <th>Объем</th>
                                <th>Полная стоимость</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var service in orderModel.OrderServicesDtos)
                            {
                                <tr>
                                    <td>@GetServiceName(service.ServiceId)</td>
                                    <td>
                                        <InputNumber class="form-control table-input" 
                                                    @bind-Value="@service.Price" 
                                                    @bind-Value:after="() => UpdateServiceTotal(service)" />
                                    </td>
                                    <td>
                                        <InputNumber class="form-control table-input" 
                                                    @bind-Value="@service.TotalVolume" 
                                                    @bind-Value:after="() => UpdateServiceTotal(service)" />
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="form-control table-input" 
                                               value="@(CalculateTotalCost(service).ToString("C"))" 
                                               readonly />
                                    </td>
                                    <td>
                                        <button type="button" class="btn-remove-compact" @onclick="() => RemoveService(service)">
                                            &times;
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="empty-services-compact">
                        <p>На данный момент нет выбранных услуг</p>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    @errorMessage
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Cancel">Отмена</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner"></span>
                        <text>Сохранение...</text>
                    }
                    else
                    {
                        <text>Сохранить</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <ServiceDialog IsVisible="@showServiceDialog"
                   AvailableServices="@availableServices"
                   OnClose="@(() => showServiceDialog = false)" 
                   OnServiceAdded="@AddService" />

    <EmployeeDialog IsVisible="@showEmployeeDialog"
                    OnClose="@(() => showEmployeeDialog = false)"
                    AvailableEmployees="@availableEmployees"
                    InitialEmployeeIds="@orderModel.OrderEmployeeDtos.Select(c=>c.Id).ToList()"
                    OnSelectionChanged="HandleEmployeeSelectionChanged" />

    <CarDialog IsVisible="@showCarDialog"
               OnClose="@(() => showCarDialog = false)"
               AvailableCars="@availableCars"
               InitialCarIds="@orderModel.OrderCarDtos.Select(c=>c.Id).ToList()"
               OnSelectionChanged="HandleCarSelectionChanged" />

@code {
    [Parameter] public int? OrderId { get; set; }
    private bool IsEditMode => (OrderId ?? 0) != 0;
    private OrderDto orderModel = new();
    private List<EmployeeDto> availableEmployees = new();
    private List<CarDto> availableCars = new();
    private List<ServiceDto> availableServices = new();
    private bool showServiceDialog = false;
    private bool showEmployeeDialog = false;
    private bool showCarDialog = false;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private bool isLocked = false;

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await TryLockAsync();
            orderModel = await ApiService.GetOrder(this.OrderId!.Value);
        }

        await LoadReferenceData();
    }

    private async Task TryLockAsync()
    {
        try
        {
            isLocked = await ApiService.LockOrder(OrderId ?? 0);
        }
        catch
        {
            isLocked = false;
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var createOrderParameters = await ApiService.GetCreateOrderParameters();
            if (createOrderParameters != null)
            {
                availableEmployees = createOrderParameters.EmployeeDtos ?? new List<EmployeeDto>();
                availableCars = createOrderParameters.CarDtos ?? new List<CarDto>();
                availableServices = createOrderParameters.ServiceDtos ?? new List<ServiceDto>();
            }
            else
            {
                availableEmployees = new List<EmployeeDto>();
                availableCars = new List<CarDto>();
                availableServices = new List<ServiceDto>();
            }
        }
        catch
        {
            errorMessage = "Failed to load reference data.";
            availableEmployees = new List<EmployeeDto>();
            availableCars = new List<CarDto>();
        }
    }

    private void ShowServiceDialog()
    {
        showServiceDialog = true;
    }

    private void ShowEmployeeDialog()
    {
        showEmployeeDialog = true;
    }

    private void ShowCarDialog()
    {
        showCarDialog = true;
    }

    private void AddService(OrderServiceDto service)
    {
        if (service.TotalVolume > 0 && service.Price > 0)
        {
            service.Price = service.Price / (decimal)service.TotalVolume;
        }
        orderModel.OrderServicesDtos.Add(service);
    }

    private void UpdateServiceTotal(OrderServiceDto service)
    {
        StateHasChanged();
    }

    private void RemoveService(OrderServiceDto service)
    {
        orderModel.OrderServicesDtos.Remove(service);
    }

    private void HandleEmployeeSelectionChanged(List<int> employeeIds)
    {
        orderModel.OrderEmployeeDtos = availableEmployees.Where(c=> employeeIds.Contains(c.Id)).ToList();
    }

    private void HandleCarSelectionChanged(List<int> carIds)
    {
        orderModel.OrderCarDtos = availableCars.Where(c=> carIds.Contains(c.Id)).ToList();
    }

    private void RemoveEmployee(EmployeeDto employeeId)
    {
        orderModel.OrderEmployeeDtos.Remove(employeeId);
    }

    private void RemoveCar(CarDto carId)
    {
        orderModel.OrderCarDtos.Remove(carId);
    }

    private string GetServiceName(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Name ?? "Unknown Service";
    }

    private string GetServiceUnit(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Measure ?? "";
    }

    private decimal GetServiceMinPrice(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinPrice ?? 0;
    }

    private double GetServiceMinVolume(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinVolume ?? 0;
    }

    private decimal CalculateTotalCost(OrderServiceDto service)
    {
        return service.Price * (decimal)service.TotalVolume;
    }

    private async Task HandleSave()
    {
        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            bool success;
            if ((OrderId ?? 0) == 0)
            {
                success = await ApiService.CreateOrder(orderModel);
            }
            else
            {
                success = await ApiService.SaveOrder(OrderId!.Value, orderModel);
            }

            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "При сохранении произошла ошибка.";
            }
        }
        catch(Exception ex)
        {
            errorMessage = $"При сохранении произошла ошибка: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (isLocked)
            {
                await ApiService.UnlockOrder(OrderId ?? 0);
                isLocked = false;
            }
        }
        catch
        {
            // ignore unlock failures
        }
    }
}


