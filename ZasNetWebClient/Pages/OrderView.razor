@page "/order/{OrderId:int?}"
@using Blazored.LocalStorage
@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using ZasNetWebClient.Components
@inject ApiService ApiService
@inject HttpClient httpClient
@inject ILocalStorageService localStorageService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>@(IsEditMode ? $"Заявка #{OrderId}" : "Создание заявки - ZasNet")</PageTitle>

    <div class="page-header-compact">
        <h1>@(IsEditMode ? $"Заявка #{OrderId}" : "Создание новой заявки")</h1>
    </div>

    <div class="create-form-container-compact">
        <EditForm Model="@orderModel" OnValidSubmit="@HandleSave">
            <DataAnnotationsValidator />
            
            <div class="form-section">
                <h3>Информация клиента</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client">Название клиента</label>
                        <InputText id="client" @bind-Value="orderModel.Client" class="form-control" placeholder="введите клиента" />
                        <ValidationMessage For="@(() => orderModel.Client)" />
                    </div>
                    <div class="form-group">
                        <label for="date">Дата начало</label>
                        <input type="datetime-local" id="date" @bind="orderModel.DateStart" class="form-control" />
                        <ValidationMessage For="@(() => orderModel.DateStart)" />
                    </div>
                    <div class="form-group">
                        <label for="date">Дата окончания</label>
                        <input type="datetime-local" id="date" @bind="orderModel.DateEnd" class="form-control" />
                    <ValidationMessage For="@(() => orderModel.DateEnd)" />
                    </div>
                    <div class="form-group">
                        <label for="payment">Вид оплаты</label>
                        <InputSelect id="payment" @bind-Value="orderModel.PaymentType" class="form-control">
                        <option value="@PaymentType.None"></option>
                        <option value="@PaymentType.Cash">Наличные</option>
                        <option value="@PaymentType.Electronic">СБП</option>
                        <option value="@PaymentType.Card">Карта</option>
                        <option value="@PaymentType.CashWithVat">Наличные с НДС</option>
                        <option value="@PaymentType.CashWithoutVat">Наличные без НДС</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => orderModel.PaymentType)" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">Город</label>
                        <InputText id="city" @bind-Value="orderModel.AddressCity" class="form-control" placeholder="введите город"/>
                        <ValidationMessage For="@(() => orderModel.AddressCity)" />
                    </div>
                    <div class="form-group">
                        <label for="street">Улица</label>
                        <InputText id="street" @bind-Value="orderModel.AddressStreet" class="form-control" placeholder="введите улицу" />
                        <ValidationMessage For="@(() => orderModel.AddressStreet)" />
                    </div>
                    <div class="form-group">
                        <label for="number">Номер дома</label>
                        <InputText id="number" @bind-Value="orderModel.AddressNumber" class="form-control" placeholder="введите номер дома" />
                        <ValidationMessage For="@(() => orderModel.AddressNumber)" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Доп. информация</label>
                    <InputTextArea id="description" @bind-Value="orderModel.Description" class="form-control" placeholder="введите доп. информацию" rows="1" />
                </div>
            </div>

            <div class="form-section">
                <h3>Информация заявки</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Общая стоимость заявки</label>
                        <input type="text" id="price" class="form-control readonly-field" value="@(orderModel.OrderPriceAmount.ToString("C"))" readonly />
                        <ValidationMessage For="@(() => orderModel.OrderPriceAmount)" />
                        <div class="form-check" style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                            <InputCheckbox id="urgentInvoice"
                                           class="form-check-input"
                                           @bind-Value="isNeedInvoiceArgently"
                                           disabled="@(!IsOrderFinished)" />
                            <label class="form-check-label" for="urgentInvoice" style="margin-right: 8px;">Срочный счет</label>
                            <button type="button"
                                class="btn-primary btn-compact"
                                    @onclick="SendToAccountant"
                                    disabled="@(!IsOrderFinished)">
                                    <text>Отправить бухгалтеру</text>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="orderStatus">Статус заявки</label>
                        <input type="text" id="orderStatus" class="form-control readonly-field" value="@GetOrderStatusDescription(orderModel.Status)" readonly />
                    </div>
                    <div class="form-group">
                        <label for="user">Диспетчер</label>
                        <input type="text" id="user" class="form-control readonly-field" value="@orderModel.CreatedUser.Name" readonly />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="services-header">
                    <h3>Услуги</h3>
                    <div class="services-actions">
                        <button type="button" class="btn-primary" @onclick="ShowServiceDialog">
                            <span>+</span> Добавить
                        </button>
                        <button type="button" class="btn-primary" @onclick="ApproveAllEmployees">
                            Подтвердить сотрудников
                        </button>
                        <button type="button" class="btn-primary" @onclick="ApproveAllCars">
                            Подтвердить машины
                        </button>
                    </div>
                </div>
                
                @if (orderModel.OrderServicesDtos.Any())
                {
                    <div class="services-table-container">
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>Наименование</th>
                                    <th>Цена</th>
                                    <th>Объем</th>
                                    <th>Полная стоимость</th>
                                    <th>Сотрудники</th>
                                    <th></th>
                                    <th>Машины</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var service in orderModel.OrderServicesDtos)
                                {
                                    <tr>
                                        <td>@GetServiceName(service.ServiceId)</td>
                                        <td>
                                            <InputNumber class="form-control table-input" 
                                                        @bind-Value="@service.Price" 
                                                        @bind-Value:after="() => UpdateServiceTotal(service)" />
                                        </td>
                                        <td>
                                            <InputNumber class="form-control table-input" 
                                                        @bind-Value="@service.TotalVolume" 
                                                        @bind-Value:after="() => UpdateServiceTotal(service)" />
                                        </td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control readonly-field table-input" 
                                                   value="@(CalculateTotalCost(service).ToString("C"))" 
                                                   readonly />
                                        </td>
                                        <td>
                                            <div class="selection-container">
                                                @if (service.OrderServiceEmployeeDtos.Any())
                                                {
                                                    <div class="selected-items">
                                                        @foreach (var orderServiceEmployee in service.OrderServiceEmployeeDtos)
                                                        {
                                                            if (orderServiceEmployee?.Employee != null)
                                                            {
                                                                <span class="selected-item">
                                                                @orderServiceEmployee.Employee.Name @(orderServiceEmployee.IsApproved ? "✅" : "❓")
                                                                    <button type="button" class="btn-remove-item" @onclick="() => RemoveEmployeeFromService(service, orderServiceEmployee)">&times;</button>
                                                                </span>
                                                            }
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-selection">Не выбраны</div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn-primary btn-compact" @onclick="() => ShowEmployeeDialog(service)">
                                                <span>+</span>
                                            </button>
                                        </td>
                                        <td>
                                            <div class="selection-container">
                                                @if (service.OrderServiceCarDtos.Any())
                                                {
                                                    <div class="selected-items">
                                                        @foreach (var orderServiceCar in service.OrderServiceCarDtos)
                                                        {
                                                            if (orderServiceCar?.Car != null)
                                                            {
                                                                <span class="selected-item">
                                                                    @orderServiceCar.Car.Name @(orderServiceCar.IsApproved ? "✅" : "❓")
                                                                    <button type="button" class="btn-remove-item" @onclick="() => RemoveCarFromService(service, orderServiceCar)">&times;</button>
                                                                </span>
                                                            }
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-selection">Не выбраны</div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn-primary btn-compact ml-compact" @onclick="() => ShowCarDialog(service)">
                                                <span>+</span>
                                            </button>
                                        </td>
                                        <td>
                                            <button type="button" class="btn-remove-compact" @onclick="() => RemoveService(service)">
                                                &times;
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-services-compact">
                        <p>На данный момент нет выбранных услуг</p>
                    </div>
                }
            </div>

            <div class="form-section">
                <h3>Документы</h3>
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex: 0 0 auto; margin-right: 10px;">
                    <label for="documentType">Тип документа</label>
                    <InputSelect id="documentType" @bind-Value="selectedDocumentType" class="form-control">
                        <option value="@DocumentType.None">Выберите тип</option>
                        <option value="@DocumentType.Invoice">Счет</option>
                        <option value="@DocumentType.ActOfCompletedWorks">Акт выполненных работ</option>
                        <option value="@DocumentType.WorkReport">Отчет о работе</option>
                    </InputSelect>
                </div>
                <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
                    <label for="file-input" class="btn-primary" style="cursor: pointer; display: inline-block; margin: 0;">
                        <span>+</span> Добавить файлы
                    </label>
                    <InputFile @ref="fileInput" id="file-input" OnChange="HandleFileSelected" multiple style="display: none;" />
                </div>
            </div>
            @if (isUploading)
            {
                <div style="margin-bottom: 10px;">
                    <p>Загрузка файлов: @uploadedFilesCount из @totalFilesCount</p>
                </div>
            }
            @if (orderModel.Documents != null && orderModel.Documents.Any())
            {
                <div class="services-table-container">
                    <table class="services-table docs-table">
                        <thead>
                            <tr>
                                <th>Имя</th>
                                <th>Тип</th>
                                <th>Дата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var doc in orderModel.Documents)
                        {
                            <tr>
                                <td>@doc.Name</td>
                                <td>@GetDocumentType(doc.DocumentType)</td>
                                <td>@doc.UploadedDate.ToString("g")</td>
                                <td>
                                    @if (doc.IsImage && !string.IsNullOrEmpty(doc.ViewUrl))
                                    {
                                        <button type="button" class="btn-primary btn-compact" @onclick="() => OpenImageDialog(doc)">Просмотр</button>
                                        var downloadAddress = $"{httpClient.BaseAddress}{doc.DownloadUrl}";
                                        <a class="btn-secondary btn-compact ml-compact" href="@downloadAddress" download>Скачать</a>
                                    }
                                    else if (!string.IsNullOrEmpty(doc.ViewUrl) && 
                                                (string.Equals(doc.ContentType, "application/pdf", StringComparison.OrdinalIgnoreCase) ||
                                                (!string.IsNullOrEmpty(doc.Extension) && doc.Extension.EndsWith("pdf", StringComparison.OrdinalIgnoreCase))))
                                    {
                                        var viewAddress = $"{httpClient.BaseAddress}{doc.ViewUrl}";
                                        var downloadAddress = $"{httpClient.BaseAddress}{doc.DownloadUrl}";
                                        <a class="btn-primary btn-compact" href="@viewAddress" target="_blank" rel="noopener noreferrer">Просмотр</a>
                                        <a class="btn-secondary btn-compact ml-compact" href="@downloadAddress" download>Скачать</a>
                                    }
                                    else
                                    {
                                        var downloadAddress = $"{httpClient.BaseAddress}{doc.DownloadUrl}";
                                        <a class="btn-primary btn-compact" href="@downloadAddress" download>Скачать</a>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
                else
                {
                    <div class="empty-services-compact">
                        <p>Документы отсутствуют</p>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    @errorMessage
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Cancel">Отмена</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner"></span>
                        <text>Сохранение...</text>
                    }
                    else
                    {
                        <text>Сохранить</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <ServiceDialog IsVisible="@showServiceDialog"
                   AvailableServices="@availableServices"
                   OnClose="@(() => showServiceDialog = false)" 
                   OnServiceAdded="@AddService" />

    <EmployeeDialog IsVisible="@showEmployeeDialog"
                    OnClose="@(() => showEmployeeDialog = false)"
                    AvailableEmployees="@availableEmployees"
                    OnSelectionChanged="HandleEmployeeSelectionChanged" />

    <CarDialog IsVisible="@showCarDialog"
               OnClose="@(() => showCarDialog = false)"
               AvailableCars="@availableCars"
               InitialCarIds="@((selectedServiceForCarDialog?.OrderServiceCarDtos?.Select(c => c.Car.Id).ToList()) ?? new List<int>())"
               OnSelectionChanged="HandleCarSelectionChanged" />

<ImageDialog IsVisible="@showImageDialog"
             OnClose="@CloseImageDialog"
             ImageViewUrl="@imageDialogUrl"
             DownloadUrl="@fileDownloadUrl" />

@code {
    [Parameter] public int? OrderId { get; set; }
    private bool IsEditMode => (OrderId ?? 0) != 0;
    private OrderDto orderModel = new();
    private List<EmployeeDto> availableEmployees = new();
    private List<CarDto> availableCars = new();
    private List<ServiceDto> availableServices = new();
    private bool showServiceDialog = false;
    private bool showEmployeeDialog = false;
    private bool showCarDialog = false;
    private bool showImageDialog = false;
    private string? imageDialogUrl;
    private string? fileDownloadUrl;
    private double imageZoom = 1.0;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private bool isLocked = false;
    private OrderServiceDto? selectedServiceForEmployeeDialog;
    private OrderServiceDto? selectedServiceForCarDialog;
    private InputFile? fileInput;
    private IBrowserFile? selectedFile;
    private DocumentType selectedDocumentType = DocumentType.None;
    private bool isUploading = false;
    private int uploadedFilesCount = 0;
    private int totalFilesCount = 0;
    private bool isNeedInvoiceArgently = false;

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await TryLockAsync();
            orderModel = await ApiService.GetOrder(this.OrderId!.Value);
            RecalculateOrderTotal();
        }
        else
        {
            var user = await localStorageService.GetItemAsync<EmployeeDto>("user");
            if (user != null)
            {
                orderModel.CreatedUser = user;
            }
        }

        await LoadReferenceData();
    }

    private async Task TryLockAsync()
    {
        try
        {
            isLocked = await ApiService.LockOrder(OrderId ?? 0);
        }
        catch
        {
            isLocked = false;
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var createOrderParameters = await ApiService.GetCreateOrderParameters();
            if (createOrderParameters != null)
            {
                availableEmployees = createOrderParameters.EmployeeDtos ?? new List<EmployeeDto>();
                availableCars = createOrderParameters.CarDtos ?? new List<CarDto>();
                availableServices = createOrderParameters.ServiceDtos ?? new List<ServiceDto>();
            }
            else
            {
                availableEmployees = new List<EmployeeDto>();
                availableCars = new List<CarDto>();
                availableServices = new List<ServiceDto>();
            }
        }
        catch
        {
            errorMessage = "Не удалось получить связанные данные";
            availableEmployees = new List<EmployeeDto>();
            availableCars = new List<CarDto>();
        }
    }

    private void ShowServiceDialog()
    {
        showServiceDialog = true;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();

        if (files == null || !files.Any())
            return;

        try
        {
            // Если OrderId еще не установлен (создание новой заявки), нужно сначала сохранить заявку
            if (!IsEditMode || orderModel.Id == 0)
            {
                errorMessage = "Сначала сохраните заявку, прежде чем добавлять документы.";
                return;
            }

            // Проверяем, выбран ли тип документа
            if (selectedDocumentType == DocumentType.None)
            {
                errorMessage = "Пожалуйста, выберите тип документа перед загрузкой.";
                return;
            }

            var user = await localStorageService.GetItemAsync<EmployeeDto>("user");
            var uploadedUserId = user?.Id;

            isUploading = true;
            totalFilesCount = files.Count;
            uploadedFilesCount = 0;
            errorMessage = string.Empty;
            StateHasChanged();

            try
            {
                // Загружаем все файлы одним запросом
                var success = await ApiService.AddDocument(
                    files,
                    orderModel.Id,
                    selectedDocumentType,
                    null, // description
                    uploadedUserId
                );

                isUploading = false;

                if (success)
                {
                    // Обновляем список документов после загрузки
                    orderModel = await ApiService.GetOrder(orderModel.Id);
                    errorMessage = string.Empty;
                }
                else
                {
                    errorMessage = "Не удалось загрузить файлы.";
                }
            }
            catch (Exception ex)
            {
                isUploading = false;
                errorMessage = $"Ошибка при загрузке файлов: {ex.Message}";
            }

            uploadedFilesCount = totalFilesCount;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            isUploading = false;
            errorMessage = $"Ошибка при загрузке файлов: {ex.Message}";
            StateHasChanged();
        }
    }

    private void ShowEmployeeDialog(OrderServiceDto service)
    {
        selectedServiceForEmployeeDialog = service;
        showEmployeeDialog = true;
    }

    private void ShowCarDialog(OrderServiceDto service)
    {
        selectedServiceForCarDialog = service;
        showCarDialog = true;
    }

    private void OpenImageDialog(DocumentDto doc)
    {
        if (doc.IsImage && !string.IsNullOrWhiteSpace(doc.ViewUrl))
        {
            imageZoom = 1.0;
            imageDialogUrl = doc.ViewUrl;
            fileDownloadUrl = doc.DownloadUrl;
            showImageDialog = true;
        }
    }

    private void CloseImageDialog()
    {
        showImageDialog = false;
        imageDialogUrl = null;
        fileDownloadUrl = null;
    }

    private void ZoomIn()
    {
        imageZoom = Math.Min(imageZoom + 0.05, 10.0);
    }

    private void ZoomOut()
    {
        imageZoom = Math.Max(imageZoom - 0.05, 0.25);
    }

    private void ResetZoom()
    {
        imageZoom = 1.0;
    }

    private void AddService(OrderServiceDto service)
    {
        if (service.TotalVolume > 0 && service.Price > 0)
        {
            service.Price = service.Price / (decimal)service.TotalVolume;
        }
        orderModel.OrderServicesDtos.Add(service);
        RecalculateOrderTotal();
    }

    private void UpdateServiceTotal(OrderServiceDto service)
    {
        RecalculateOrderTotal();
        StateHasChanged();
    }

    private void RemoveService(OrderServiceDto service)
    {
        orderModel.OrderServicesDtos.Remove(service);
        RecalculateOrderTotal();
    }

    private void HandleEmployeeSelectionChanged(List<int> employeeIds)
    {
        if (selectedServiceForEmployeeDialog == null)
        {
            return;
        }

        var orderServiceId = selectedServiceForEmployeeDialog.Id;

        var selected = availableEmployees
            .Where(c => employeeIds.Contains(c.Id))
            .Select(e => new OrderServiceEmployeeDto
                {
                    OrderServiceId = orderServiceId,
                    Employee = e
                })
            .ToList();

        // Append new selections without deduplication to allow multiple assignments
        selectedServiceForEmployeeDialog.OrderServiceEmployeeDtos.AddRange(selected);
    }

    private void HandleCarSelectionChanged(List<int> carIds)
    {
        if (selectedServiceForCarDialog == null)
        {
            return;
        }

        var orderServiceId = selectedServiceForCarDialog.Id;

        var selected = availableCars
            .Where(c => carIds.Contains(c.Id))
            .Select(c => new OrderServiceCarDto
                {
                    OrderServiceId = orderServiceId,
                    Car = c
                })
            .ToList();

        selectedServiceForCarDialog.OrderServiceCarDtos = selected;
    }

    private void RemoveEmployeeFromService(OrderServiceDto service, OrderServiceEmployeeDto association)
    {
        service.OrderServiceEmployeeDtos.Remove(association);
    }

    private void RemoveCarFromService(OrderServiceDto service, OrderServiceCarDto association)
    {
        service.OrderServiceCarDtos.Remove(association);
    }

    private void ApproveAllEmployees()
    {
        foreach (var service in orderModel.OrderServicesDtos)
        {
            foreach (var association in service.OrderServiceEmployeeDtos)
            {
                association.IsApproved = true;
            }
        }

        orderModel.Status = OrderStatus.ApprovedWithEmployers;
    }

    private void ApproveAllCars()
    {
        foreach (var service in orderModel.OrderServicesDtos)
        {
            foreach (var association in service.OrderServiceCarDtos)
            {
                association.IsApproved = true;
            }
        }
    }

    private string GetServiceName(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Name ?? "Неизвестная услуга";
    }

    private string GetServiceUnit(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Measure ?? "";
    }

    private string GetOrderStatusDescription(OrderStatus orderStatus)
    {
        if (orderStatus == OrderStatus.Created)
        {
            return "Создан";
        }
        else if(orderStatus == OrderStatus.ApprovedWithEmployers)
        {
            return "Подтвержден сотрудниками";
        }
        else if (orderStatus == OrderStatus.Processing)
        {
            return "В работе";
        }
        else if (orderStatus == OrderStatus.Finished)
        {
            return "Завершен";
        }
        else if (orderStatus == OrderStatus.CreatingInvoice)
        {
            return "Ожидание счета";
        }
        else if (orderStatus == OrderStatus.AwaitingPayment)
        {
            return "Ожидание оплаты";
        }
        else if (orderStatus == OrderStatus.Closed)
        {
            return "Закрыт";
        }

        return "Не известно";
    }

    private bool IsOrderFinished => orderModel.Status == OrderStatus.Finished;

    private string GetDocumentType(DocumentType documentType)
    {
        if (documentType == DocumentType.ActOfCompletedWorks)
        {
            return "Акт выполненных работ";
        }
        else if (documentType == DocumentType.Invoice)
        {
            return "Счет";
        }
        else if (documentType == DocumentType.WorkReport)
        {
            return "Отчет о работе";
        }

        return "Не известно";
    }

    private decimal GetServiceMinPrice(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinPrice ?? 0;
    }

    private double GetServiceMinVolume(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinVolume ?? 0;
    }

    private decimal CalculateTotalCost(OrderServiceDto service)
    {
        return service.Price * (decimal)service.TotalVolume;
    }

    private void RecalculateOrderTotal()
    {
        orderModel.OrderPriceAmount = orderModel.OrderServicesDtos.Sum(s => CalculateTotalCost(s));
    }

    private void NormalizeOrderServiceIds()
    {
        foreach (var service in orderModel.OrderServicesDtos)
        {
            var orderServiceId = service.Id;
            foreach (var emp in service.OrderServiceEmployeeDtos)
            {
                emp.OrderServiceId = orderServiceId;
            }
            foreach (var car in service.OrderServiceCarDtos)
            {
                car.OrderServiceId = orderServiceId;
            }
        }
    }

    private async Task HandleSave()
    {
        NormalizeOrderServiceIds();
        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            bool success;
            if ((OrderId ?? 0) == 0)
            {
                success = await ApiService.CreateOrder(orderModel);
            }
            else
            {
                success = await ApiService.SaveOrder(orderModel);
            }

            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "При сохранении произошла ошибка.";
            }
        }
        catch(Exception ex)
        {
            errorMessage = $"При сохранении произошла ошибка: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private async Task SendToAccountant()
    {
        errorMessage = string.Empty;

        try
        {
            var success = await ApiService.ChangeStatusToWaitingInvoice(new ChangeStatusToWaitingInvoiceDto(orderModel.Id, isNeedInvoiceArgently));

            if (success)
            {
                // Локально обновляем статус, чтобы отразить изменения в UI
                orderModel.Status = OrderStatus.CreatingInvoice;
            }
            else
            {
                errorMessage = "Не удалось отправить заявку бухгалтеру.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка при отправке заявки бухгалтеру: {ex.Message}";
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (isLocked)
            {
                await ApiService.UnlockOrder(OrderId ?? 0);
                isLocked = false;
            }
        }
        catch
        {
            // ignore unlock failures
        }
    }
}


