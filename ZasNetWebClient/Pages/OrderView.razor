@page "/order/{OrderId:int?}"
@using Blazored.LocalStorage
@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using ZasNetWebClient.Components
@inject ApiService ApiService
@inject HttpClient httpClient
@inject ILocalStorageService localStorageService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@implements IAsyncDisposable

<PageTitle>@(IsEditMode ? $"–ó–∞—è–≤–∫–∞ #{OrderId}" : "–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ - ZasNet")</PageTitle>

    <div class="page-header-compact">
        <h1>@(IsEditMode ? $"–ó–∞—è–≤–∫–∞ #{OrderId}" : "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏")</h1>
    </div>

    <div class="create-form-container-compact">
        <EditForm Model="@orderModel" OnValidSubmit="@HandleSave">
            <DataAnnotationsValidator />
            
            <div class="form-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <InputText id="client" @bind-Value="orderModel.Client" class="form-control" placeholder="–≤–≤–µ–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞" disabled="@isDriverOrAccountantRole" />
                        <ValidationMessage For="@(() => orderModel.Client)" />
                    </div>
                    <div class="form-group">
                        <label for="date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–æ</label>
                        <input type="datetime-local" id="date" @bind="orderModel.DateStart" class="form-control" disabled="@isDriverOrAccountantRole" />
                        <ValidationMessage For="@(() => orderModel.DateStart)" />
                    </div>
                    <div class="form-group">
                        <label for="date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="datetime-local" id="date" @bind="orderModel.DateEnd" class="form-control" disabled="@isDriverOrAccountantRole" />
                    <ValidationMessage For="@(() => orderModel.DateEnd)" />
                    </div>
                    <div class="form-group">
                        <label for="payment">–í–∏–¥ –æ–ø–ª–∞—Ç—ã</label>
                        <InputSelect id="payment" @bind-Value="orderModel.PaymentType" class="form-control" disabled="@isDriverOrAccountantRole">
                        <option value="@PaymentType.None"></option>
                        <option value="@PaymentType.Cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                        <option value="@PaymentType.Electronic">–°–ë–ü</option>
                        <option value="@PaymentType.Card">–ö–∞—Ä—Ç–∞</option>
                        <option value="@PaymentType.CashWithVat">–ù–∞–ª–∏—á–Ω—ã–µ —Å –ù–î–°</option>
                        <option value="@PaymentType.CashWithoutVat">–ù–∞–ª–∏—á–Ω—ã–µ –±–µ–∑ –ù–î–°</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => orderModel.PaymentType)" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">–ì–æ—Ä–æ–¥</label>
                        <InputText id="city" @bind-Value="orderModel.AddressCity" class="form-control" placeholder="–≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥" disabled="@isDriverOrAccountantRole"/>
                        <ValidationMessage For="@(() => orderModel.AddressCity)" />
                    </div>
                    <div class="form-group">
                        <label for="street">–£–ª–∏—Ü–∞</label>
                        <InputText id="street" @bind-Value="orderModel.AddressStreet" class="form-control" placeholder="–≤–≤–µ–¥–∏—Ç–µ —É–ª–∏—Ü—É" disabled="@isDriverOrAccountantRole" />
                        <ValidationMessage For="@(() => orderModel.AddressStreet)" />
                    </div>
                    <div class="form-group">
                        <label for="number">–ù–æ–º–µ—Ä –¥–æ–º–∞</label>
                        <InputText id="number" @bind-Value="orderModel.AddressNumber" class="form-control" placeholder="–≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–º–∞" disabled="@isDriverOrAccountantRole" />
                        <ValidationMessage For="@(() => orderModel.AddressNumber)" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                    <InputTextArea id="description" @bind-Value="orderModel.Description" class="form-control" placeholder="–≤–≤–µ–¥–∏—Ç–µ –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é" rows="1" disabled="@isDriverOrAccountantRole" />
                </div>
                <div class="form-row" style="margin-top: 15px;">
                    @if (orderModel.PaymentType == PaymentType.Cash)
                    {
                        <div class="form-group">
                            <div class="checkbox-wrapper">
                                <InputCheckbox id="isCashWasTransferred" @bind-Value="orderModel.IsCashWasTransferred" class="form-check-input" disabled="@isDriverOrAccountantRole" />
                                <label class="form-check-label" for="isCashWasTransferred">–ù–∞–ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã</label>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="form-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞—è–≤–∫–∏</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞—è–≤–∫–∏</label>
                        <input type="text" id="price" class="form-control readonly-field" value="@(orderModel.OrderPriceAmount.ToString("C"))" readonly />
                        <ValidationMessage For="@(() => orderModel.OrderPriceAmount)" />
                    </div>
                    <div class="form-group">
                        <label for="orderStatus">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</label>
                        <input type="text" id="orderStatus" class="form-control readonly-field" value="@GetOrderStatusDescription(orderModel.Status)" readonly />
                    </div>
                    <div class="form-group">
                        <label for="user">–î–∏—Å–ø–µ—Ç—á–µ—Ä</label>
                        <input type="text" id="user" class="form-control readonly-field" value="@orderModel.CreatedUser.Name" readonly />
                    </div>
                </div>
                @* <div class="form-check" style="display: flex; align-items: center; gap: 8px; margin-top: 10px;"> *@
                @if (!isDriverOrAccountantRole)
                {
                    <div style="display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap; width: 100%;">
                        <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            <InputCheckbox id="urgentInvoice"
                                           class="form-check-input"
                                           @bind-Value="isNeedInvoiceArgently"
                                           disabled="@(!IsOrderFinished)" />
                            <label class="form-check-label" for="urgentInvoice" style="margin: 0; white-space: nowrap;">–°—Ä–æ—á–Ω—ã–π —Å—á–µ—Ç</label>
                        </div>
                        <button type="button"
                            class="btn-primary btn-compact"
                                style="flex-shrink: 0; white-space: nowrap;"
                                @onclick="SendToAccountant"
                                disabled="@(!IsOrderFinished)">
                                <text>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É</text>
                        </button>
                        <button type="button"
                            class="btn-primary btn-compact"
                                style="flex-shrink: 0; white-space: nowrap;"
                            @onclick="SendedToClient"
                                disabled="@(orderModel.Status != OrderStatus.SendingPayment)">
                                <text>–°—á. –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É</text>
                        </button>
                        <button type="button"
                            class="btn-primary btn-compact"
                                style="flex-shrink: 0; white-space: nowrap;"
                                @onclick="CloseOrder"
                                disabled="@(!CanCloseOrder)">
                                <text>–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</text>
                        </button>
                        <button type="button"
                            class="btn-danger btn-compact"
                                style="flex-shrink: 0; white-space: nowrap;"
                                @onclick="ShowDeleteConfirmation"
                                disabled="@(!IsEditMode)">
                                <text>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</text>
                        </button>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0; flex: 1 1 auto;">
                            <label for="statusSelect" style="margin: 0; white-space: nowrap; flex-shrink: 0;">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; min-width: 0; flex: 1 1 auto;">
                                <InputSelect id="statusSelect" @bind-Value="selectedStatus" class="form-control" style="min-width: 150px; max-width: 220px; flex: 1 1 auto; padding: 4px 8px; font-size: 13px; height: auto;">
                                    <option value="@OrderStatus.Created">–°–æ–∑–¥–∞–Ω</option>
                                    <option value="@OrderStatus.ApprovedWithEmployers">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</option>
                                    <option value="@OrderStatus.Processing">–í —Ä–∞–±–æ—Ç–µ</option>
                                    <option value="@OrderStatus.Finished">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                                    <option value="@OrderStatus.CreatingInvoice">–û–∂–∏–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞</option>
                                    <option value="@OrderStatus.SendingPayment">–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—á–µ—Ç–∞</option>
                                    <option value="@OrderStatus.AwaitingPayment">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</option>
                                    <option value="@OrderStatus.Closed">–ó–∞–∫—Ä—ã—Ç</option>
                                </InputSelect>
                                <button type="button"
                                        class="btn-primary btn-compact"
                                        style="flex-shrink: 0; white-space: nowrap; padding: 4px 10px; font-size: 13px;"
                                        @onclick="ChangeStatus"
                                        disabled="@(!IsEditMode)">
                                    <text>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</text>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="form-section">
                <div class="services-header">
                    <h3>–£—Å–ª—É–≥–∏</h3>
                    <div class="services-actions">
                        <button type="button" class="btn-primary" @onclick="ShowServiceDialog">
                            <span>+</span> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                        <button type="button" class="btn-primary" @onclick="ApproveAllEmployees">
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                        </button>
                        <button type="button" class="btn-primary" @onclick="ApproveAllCars">
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –º–∞—à–∏–Ω—ã
                        </button>
                    </div>
                </div>
                
                @if (orderModel.OrderServicesDtos.Any())
                {
                    <div class="services-table-container">
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                    <th>–¶–µ–Ω–∞</th>
                                    <th>–û–±—ä–µ–º</th>
                                    <th>–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
                                    <th></th>
                                    <th>–ú–∞—à–∏–Ω—ã</th>
                                    <th></th>
                                    <th style="text-align: center;">–£—Å–ª—É–≥–∞ –ê–ª–º–∞–∑–∞</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var service in orderModel.OrderServicesDtos)
                                {
                                    <tr>
                                        <td>@GetServiceName(service.ServiceId)</td>
                                        <td>
                                            <InputNumber class="form-control table-input" 
                                                        @bind-Value="@service.Price" 
                                                        @bind-Value:after="() => UpdateServiceTotal(service)" />
                                        </td>
                                        <td>
                                            <InputNumber class="form-control table-input" 
                                                        @bind-Value="@service.TotalVolume" 
                                                        @bind-Value:after="() => UpdateServiceTotal(service)" />
                                        </td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control readonly-field table-input" 
                                                   value="@(CalculateTotalCost(service).ToString("C"))" 
                                                   readonly />
                                        </td>
                                        <td>
                                            <div class="selection-container">
                                                @if (service.OrderServiceEmployeeDtos.Any())
                                                {
                                                    <div class="selected-items">
                                                        @foreach (var orderServiceEmployee in service.OrderServiceEmployeeDtos)
                                                        {
                                                            if (orderServiceEmployee?.Employee != null)
                                                            {
                                                                <span class="selected-item">
                                                                @orderServiceEmployee.Employee.Name @(orderServiceEmployee.IsApproved ? "‚úÖ" : "‚ùì")
                                                                    <button type="button" class="btn-remove-item" @onclick="() => RemoveEmployeeFromService(service, orderServiceEmployee)">&times;</button>
                                                                </span>
                                                            }
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-selection">–ù–µ –≤—ã–±—Ä–∞–Ω—ã</div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn-primary btn-compact" @onclick="() => ShowEmployeeDialog(service)">
                                                <span>+</span>
                                            </button>
                                        </td>
                                        <td>
                                            <div class="selection-container">
                                                @if (service.OrderServiceCarDtos.Any())
                                                {
                                                    <div class="selected-items">
                                                        @foreach (var orderServiceCar in service.OrderServiceCarDtos)
                                                        {
                                                            if (orderServiceCar?.Car != null)
                                                            {
                                                                <span class="selected-item">
                                                                    @orderServiceCar.Car.Name @(orderServiceCar.IsApproved ? "‚úÖ" : "‚ùì")
                                                                    <button type="button" class="btn-remove-item" @onclick="() => RemoveCarFromService(service, orderServiceCar)">&times;</button>
                                                                </span>
                                                            }
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-selection">–ù–µ –≤—ã–±—Ä–∞–Ω—ã</div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn-primary btn-compact ml-compact" @onclick="() => ShowCarDialog(service)">
                                                <span>+</span>
                                            </button>
                                        </td>
                                        <td style="text-align: center;">
                                            <InputCheckbox id="isAlmazOrder" @bind-Value="service.IsAlmazService" class="form-check-input" disabled="@isDriverOrAccountantRole" />
                                        </td>
                                        <td>
                                            <button type="button" class="btn-remove-compact" @onclick="() => RemoveService(service)">
                                                &times;
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-services-compact">
                        <p>–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥</p>
                    </div>
                }
            </div>

            <div class="form-section">
                <h3>–î–æ–∫—É–º–µ–Ω—Ç—ã</h3>
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex: 0 0 auto; margin-right: 10px;">
                    <label for="documentType">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    @if (isDriverOrAccountantRole)
                    {
                        <InputSelect id="documentType" @bind-Value="selectedDocumentType" class="form-control" disabled>
                            <option value="@DocumentType.WorkReport">–û—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ</option>
                        </InputSelect>
                    }
                    else
                    {
                        <InputSelect id="documentType" @bind-Value="selectedDocumentType" class="form-control">
                            <option value="@DocumentType.None">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="@DocumentType.Invoice">–°—á–µ—Ç</option>
                            <option value="@DocumentType.ActOfCompletedWorks">–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</option>
                            <option value="@DocumentType.WorkReport">–û—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ</option>
                        </InputSelect>
                    }
                </div>
                <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
                    <label for="file-input" class="btn-primary" style="cursor: pointer; display: inline-block; margin: 0;">
                        <span>+</span> –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã
                    </label>
                    <InputFile @ref="fileInput" id="file-input" OnChange="HandleFileSelected" multiple style="display: none;" />
                </div>
            </div>
            @if (isUploading)
            {
                <div style="margin-bottom: 10px;">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: @uploadedFilesCount –∏–∑ @totalFilesCount</p>
                </div>
            }
            @if (orderModel.Documents != null && orderModel.Documents.Any())
            {
                <div class="services-table-container">
                    <table class="services-table docs-table">
                        <thead>
                            <tr>
                                <th>–ò–º—è</th>
                                <th>–¢–∏–ø</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var doc in orderModel.Documents)
                        {
                            <tr>
                                <td>@doc.Name</td>
                                <td>@GetDocumentType(doc.DocumentType)</td>
                                <td>@doc.UploadedDate.ToString("g")</td>
                                <td>
                                    @if (doc.IsImage && !string.IsNullOrEmpty(doc.ViewUrl))
                                    {
                                        <button type="button" class="btn-primary btn-compact" @onclick="() => OpenImageDialog(doc)">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                                        var downloadAddress = $"{httpClient.BaseAddress}{doc.DownloadUrl}";
                                        <a class="btn-secondary btn-compact ml-compact" href="@downloadAddress" download>–°–∫–∞—á–∞—Ç—å</a>
                                    }
                                    else if (!string.IsNullOrEmpty(doc.ViewUrl) && 
                                                (string.Equals(doc.ContentType, "application/pdf", StringComparison.OrdinalIgnoreCase) ||
                                                (!string.IsNullOrEmpty(doc.Extension) && doc.Extension.EndsWith("pdf", StringComparison.OrdinalIgnoreCase))))
                                    {
                                        var viewAddress = $"{httpClient.BaseAddress}{doc.ViewUrl}";
                                        var downloadAddress = $"{httpClient.BaseAddress}{doc.DownloadUrl}";
                                        <a class="btn-primary btn-compact" href="@viewAddress" target="_blank" rel="noopener noreferrer">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                                        <a class="btn-secondary btn-compact ml-compact" href="@downloadAddress" download>–°–∫–∞—á–∞—Ç—å</a>
                                    }
                                    else
                                    {
                                        var downloadAddress = $"{httpClient.BaseAddress}{doc.DownloadUrl}";
                                        <a class="btn-primary btn-compact" href="@downloadAddress" download>–°–∫–∞—á–∞—Ç—å</a>
                                    }
                                </td>
                                <td>
                                    @if (!isDriverOrAccountantRole || doc.DocumentType == DocumentType.WorkReport)
                                    {
                                        <button type="button" class="btn-remove-compact" @onclick="() => RemoveDocument(doc)">
                                            &times;
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
                else
                {
                    <div class="empty-services-compact">
                        <p>–î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
                    </div>
                }
            </div>

            @* –õ–æ–∫–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏ —É–±—Ä–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π alert *@

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner"></span>
                        <text>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</text>
                    }
                    else
                    {
                        <text>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <ServiceDialog IsVisible="@showServiceDialog"
                   AvailableServices="@availableServices"
                   OnClose="@(() => showServiceDialog = false)" 
                   OnServiceAdded="@AddService" />

    <EmployeeDialog IsVisible="@showEmployeeDialog"
                    OnClose="@(() => showEmployeeDialog = false)"
                    AvailableEmployees="@availableEmployees"
                    OnSelectionChanged="HandleEmployeeSelectionChanged" />

    <CarDialog IsVisible="@showCarDialog"
               OnClose="@(() => showCarDialog = false)"
               AvailableCars="@availableCars"
               InitialCarIds="@((selectedServiceForCarDialog?.OrderServiceCarDtos?.Select(c => c.Car.Id).ToList()) ?? new List<int>())"
               OnSelectionChanged="HandleCarSelectionChanged" />

<ImageDialog IsVisible="@showImageDialog"
             OnClose="@CloseImageDialog"
             ImageViewUrl="@imageDialogUrl"
             DownloadUrl="@fileDownloadUrl" />

<ConfirmDialog IsVisible="@showConfirmDialog"
               Title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"
               Message="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ–π –∑–∞—è–≤–∫–∏"
               OnConfirm="@ConfirmSave"
               OnCancel="@CancelSave" />

<ConfirmDialog IsVisible="@showDeleteConfirmDialog"
               Title="–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏"
               Message="@($"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #{OrderId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")"
               OnConfirm="@ConfirmDelete"
               OnCancel="@CancelDelete" />

@code {
    [Parameter] public int? OrderId { get; set; }
    private bool IsEditMode => (OrderId ?? 0) != 0;
    private OrderDto orderModel = new();
    private List<EmployeeDto> availableEmployees = new();
    private List<CarDto> availableCars = new();
    private List<ServiceDto> availableServices = new();
    private bool showServiceDialog = false;
    private bool showEmployeeDialog = false;
    private bool showCarDialog = false;
    private bool showImageDialog = false;
    private bool showConfirmDialog = false;
    private bool showDeleteConfirmDialog = false;
    private string? imageDialogUrl;
    private string? fileDownloadUrl;
    private double imageZoom = 1.0;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private bool isLocked = false;
    private OrderServiceDto? selectedServiceForEmployeeDialog;
    private OrderServiceDto? selectedServiceForCarDialog;
    private InputFile? fileInput;
    private IBrowserFile? selectedFile;
    private DocumentType selectedDocumentType = DocumentType.None;
    private bool isUploading = false;
    private int uploadedFilesCount = 0;
    private int totalFilesCount = 0;
    private bool isNeedInvoiceArgently = false;
    private OrderStatus selectedStatus = OrderStatus.Created;
    private EmployeeDto? currentUser;
    private bool isDriverOrAccountantRole = false;

    protected override async Task OnInitializedAsync()
    {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currentUser = await localStorageService.GetItemAsync<EmployeeDto>("user");
        if (currentUser != null && currentUser.Role != null)
        {
            isDriverOrAccountantRole = currentUser.Role.Name.Equals("–í–æ–¥–∏—Ç–µ–ª—å", StringComparison.OrdinalIgnoreCase) || currentUser.Role.Name.Equals("–ë—É—Ö–≥–∞–ª—Ç–µ—Ä", StringComparison.OrdinalIgnoreCase);
        }

        if (IsEditMode)
        {
            await TryLockAsync();
            orderModel = await ApiService.GetOrder(this.OrderId!.Value);
            selectedStatus = orderModel.Status;
            RecalculateOrderTotal();
        }
        else
        {
            if (currentUser != null)
            {
                orderModel.CreatedUser = currentUser;
            }
        }

        await LoadReferenceData();
        
        // –î–ª—è —Ä–æ–ª–∏ –í–æ–¥–∏—Ç–µ–ª—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (isDriverOrAccountantRole)
        {
            selectedDocumentType = DocumentType.WorkReport;
        }
    }

    private async Task TryLockAsync()
    {
        try
        {
            isLocked = await ApiService.LockOrder(OrderId ?? 0);
        }
        catch
        {
            isLocked = false;
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var createOrderParameters = await ApiService.GetCreateOrderParameters();
            if (createOrderParameters != null)
            {
                availableEmployees = createOrderParameters.EmployeeDtos ?? new List<EmployeeDto>();
                availableCars = createOrderParameters.CarDtos ?? new List<CarDto>();
                availableServices = createOrderParameters.ServiceDtos ?? new List<ServiceDto>();
            }
            else
            {
                availableEmployees = new List<EmployeeDto>();
                availableCars = new List<CarDto>();
                availableServices = new List<ServiceDto>();
            }
        }
        catch
        {
            errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ";
            NotificationService.ShowError(errorMessage);
            availableEmployees = new List<EmployeeDto>();
            availableCars = new List<CarDto>();
        }
    }

    private void ShowServiceDialog()
    {
        showServiceDialog = true;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();

        if (files == null || !files.Any())
            return;

        try
        {
            // –ï—Å–ª–∏ OrderId –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏), –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
            if (!IsEditMode || orderModel.Id == 0)
            {
                errorMessage = "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞—è–≤–∫—É, –ø—Ä–µ–∂–¥–µ —á–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã.";
                NotificationService.ShowError(errorMessage);
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
            if (selectedDocumentType == DocumentType.None)
            {
                errorMessage = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π.";
                NotificationService.ShowError(errorMessage);
                return;
            }

            // –î–ª—è —Ä–æ–ª–∏ –í–æ–¥–∏—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–∏–ø "–û—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ"
            if (isDriverOrAccountantRole && selectedDocumentType != DocumentType.WorkReport)
            {
                errorMessage = "–î–ª—è –≤–∞—à–µ–π —Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ç–∏–ø–∞ '–û—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ'.";
                NotificationService.ShowError(errorMessage);
                return;
            }

            var user = await localStorageService.GetItemAsync<EmployeeDto>("user");
            var uploadedUserId = user?.Id;

            isUploading = true;
            totalFilesCount = files.Count;
            uploadedFilesCount = 0;
            errorMessage = string.Empty;
            NotificationService.Clear();
            StateHasChanged();

            try
            {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
                var success = await ApiService.AddDocument(
                    files,
                    orderModel.Id,
                    selectedDocumentType,
                    null, // description
                    uploadedUserId
                );

                isUploading = false;

                if (success)
                {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    orderModel = await ApiService.GetOrder(orderModel.Id);
                    errorMessage = string.Empty;
                    NotificationService.Clear();
                }
                else
                {
                    errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã.";
                    NotificationService.ShowError(errorMessage);
                }
            }
            catch (Exception ex)
            {
                isUploading = false;
                errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤: {ex.Message}";
                NotificationService.ShowError(errorMessage);
            }

            uploadedFilesCount = totalFilesCount;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            isUploading = false;
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤: {ex.Message}";
            NotificationService.ShowError(errorMessage);
            StateHasChanged();
        }
    }

    private void ShowEmployeeDialog(OrderServiceDto service)
    {
        selectedServiceForEmployeeDialog = service;
        showEmployeeDialog = true;
    }

    private void ShowCarDialog(OrderServiceDto service)
    {
        selectedServiceForCarDialog = service;
        showCarDialog = true;
    }

    private void OpenImageDialog(DocumentDto doc)
    {
        if (doc.IsImage && !string.IsNullOrWhiteSpace(doc.ViewUrl))
        {
            imageZoom = 1.0;
            imageDialogUrl = doc.ViewUrl;
            fileDownloadUrl = doc.DownloadUrl;
            showImageDialog = true;
        }
    }

    private void CloseImageDialog()
    {
        showImageDialog = false;
        imageDialogUrl = null;
        fileDownloadUrl = null;
    }

    private void ZoomIn()
    {
        imageZoom = Math.Min(imageZoom + 0.05, 10.0);
    }

    private void ZoomOut()
    {
        imageZoom = Math.Max(imageZoom - 0.05, 0.25);
    }

    private void ResetZoom()
    {
        imageZoom = 1.0;
    }

    private void AddService(OrderServiceDto service)
    {
        if (service.TotalVolume > 0 && service.Price > 0)
        {
            service.Price = service.Price / (decimal)service.TotalVolume;
        }
        orderModel.OrderServicesDtos.Add(service);
        RecalculateOrderTotal();
    }

    private void UpdateServiceTotal(OrderServiceDto service)
    {
        RecalculateOrderTotal();
        StateHasChanged();
    }

    private void RemoveService(OrderServiceDto service)
    {
        orderModel.OrderServicesDtos.Remove(service);
        RecalculateOrderTotal();
    }

    private void RemoveDocument(DocumentDto documentDto)
    {
        orderModel.Documents.Remove(documentDto);
    }

    private void HandleEmployeeSelectionChanged(List<int> employeeIds)
    {
        if (selectedServiceForEmployeeDialog == null)
        {
            return;
        }

        var orderServiceId = selectedServiceForEmployeeDialog.Id;

        var selected = availableEmployees
            .Where(c => employeeIds.Contains(c.Id))
            .Select(e => new OrderServiceEmployeeDto
                {
                    OrderServiceId = orderServiceId,
                    Employee = e
                })
            .ToList();

        // Append new selections without deduplication to allow multiple assignments
        selectedServiceForEmployeeDialog.OrderServiceEmployeeDtos.AddRange(selected);
    }

    private void HandleCarSelectionChanged(List<int> carIds)
    {
        if (selectedServiceForCarDialog == null)
        {
            return;
        }

        var orderServiceId = selectedServiceForCarDialog.Id;

        var selected = availableCars
            .Where(c => carIds.Contains(c.Id))
            .Select(c => new OrderServiceCarDto
                {
                    OrderServiceId = orderServiceId,
                    Car = c
                })
            .ToList();

        selectedServiceForCarDialog.OrderServiceCarDtos = selected;
    }

    private void RemoveEmployeeFromService(OrderServiceDto service, OrderServiceEmployeeDto association)
    {
        service.OrderServiceEmployeeDtos.Remove(association);
    }

    private void RemoveCarFromService(OrderServiceDto service, OrderServiceCarDto association)
    {
        service.OrderServiceCarDtos.Remove(association);
    }

    private void ApproveAllEmployees()
    {
        foreach (var service in orderModel.OrderServicesDtos)
        {
            foreach (var association in service.OrderServiceEmployeeDtos)
            {
                association.IsApproved = true;
            }
        }

        if (orderModel.Status == OrderStatus.Created)
        {
            orderModel.Status = OrderStatus.ApprovedWithEmployers;
        }
    }

    private void ApproveAllCars()
    {
        foreach (var service in orderModel.OrderServicesDtos)
        {
            foreach (var association in service.OrderServiceCarDtos)
            {
                association.IsApproved = true;
            }
        }
    }

    private string GetServiceName(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Name ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞";
    }

    private string GetServiceUnit(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Measure ?? "";
    }

    private string GetOrderStatusDescription(OrderStatus orderStatus)
    {
        if (orderStatus == OrderStatus.Created)
        {
            return "–°–æ–∑–¥–∞–Ω";
        }
        else if(orderStatus == OrderStatus.ApprovedWithEmployers)
        {
            return "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏";
        }
        else if (orderStatus == OrderStatus.Processing)
        {
            return "–í —Ä–∞–±–æ—Ç–µ";
        }
        else if (orderStatus == OrderStatus.Finished)
        {
            return "–ó–∞–≤–µ—Ä—à–µ–Ω";
        }
        else if (orderStatus == OrderStatus.CreatingInvoice)
        {
            return "–û–∂–∏–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞";
        }
        else if (orderStatus == OrderStatus.SendingPayment)
        {
            return "–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—á–µ—Ç–∞";
        }
        else if (orderStatus == OrderStatus.AwaitingPayment)
        {
            return "–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã";
        }
        else if (orderStatus == OrderStatus.Closed)
        {
            return "–ó–∞–∫—Ä—ã—Ç";
        }

        return "–ù–µ –∏–∑–≤–µ—Å—Ç–Ω–æ";
    }

    private bool IsOrderFinished => orderModel.Status == OrderStatus.Finished;

    private bool CanCloseOrder => orderModel.Status == OrderStatus.AwaitingPayment || orderModel.Status == OrderStatus.Finished;

    private string GetDocumentType(DocumentType documentType)
    {
        if (documentType == DocumentType.ActOfCompletedWorks)
        {
            return "–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç";
        }
        else if (documentType == DocumentType.Invoice)
        {
            return "–°—á–µ—Ç";
        }
        else if (documentType == DocumentType.WorkReport)
        {
            return "–û—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ";
        }

        return "–ù–µ –∏–∑–≤–µ—Å—Ç–Ω–æ";
    }

    private decimal GetServiceMinPrice(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinPrice ?? 0;
    }

    private double GetServiceMinVolume(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinVolume ?? 0;
    }

    private decimal CalculateTotalCost(OrderServiceDto service)
    {
        return service.Price * (decimal)service.TotalVolume;
    }

    private void RecalculateOrderTotal()
    {
        orderModel.OrderPriceAmount = orderModel.OrderServicesDtos.Sum(s => CalculateTotalCost(s));
    }

    private void NormalizeOrderServiceIds()
    {
        foreach (var service in orderModel.OrderServicesDtos)
        {
            var orderServiceId = service.Id;
            foreach (var emp in service.OrderServiceEmployeeDtos)
            {
                emp.OrderServiceId = orderServiceId;
            }
            foreach (var car in service.OrderServiceCarDtos)
            {
                car.OrderServiceId = orderServiceId;
            }
        }
    }

    private async Task HandleSave()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ Closed, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        if (orderModel.Status == OrderStatus.Closed)
        {
            showConfirmDialog = true;
            return;
        }

        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ Closed, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        await PerformSave();
    }

    private async Task ConfirmSave()
    {
        showConfirmDialog = false;
        await PerformSave();
    }

    private void CancelSave()
    {
        showConfirmDialog = false;
        // –û—Ç–º–µ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    }

    private async Task PerformSave()
    {
        NormalizeOrderServiceIds();
        isSubmitting = true;
        errorMessage = string.Empty;
        NotificationService.Clear();

        try
        {
            bool success = false;
            if ((OrderId ?? 0) == 0)
            {
                success = await ApiService.CreateOrder(orderModel);
            }
            else
            {
                success = await ApiService.SaveOrder(orderModel);
            }

            if (success)
            {
                NotificationService.ShowInfo("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.");
                Navigation.NavigateTo("/");
            }
        }
        catch(Exception ex)
        {
            errorMessage = $"–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {ex.Message}";
            NotificationService.ShowError(errorMessage);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private void CloseError()
    {
        errorMessage = string.Empty;
    }

    private async Task SendToAccountant()
    {
        errorMessage = string.Empty;
        NotificationService.Clear();

        try
        {
            var success = await ApiService.ChangeStatusToWaitingInvoice(new ChangeStatusToWaitingInvoiceDto(orderModel.Id, isNeedInvoiceArgently));

            if (success)
            {
                // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ UI
                orderModel.Status = OrderStatus.CreatingInvoice;
            }
            else
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É: {ex.Message}";
            NotificationService.ShowError(errorMessage);
        }
    }
    
    private async Task SendedToClient()
    {
        errorMessage = string.Empty;
        NotificationService.Clear();

        try
        {
            var command = new ChangeOrderStatusCommand(orderModel.Id, OrderStatus.AwaitingPayment);
            var success = await ApiService.ChangeOrderStatus(command);

            if (success)
            {
                // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ UI
                orderModel.Status = OrderStatus.AwaitingPayment;
                NotificationService.ShowInfo($"–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {GetOrderStatusDescription(OrderStatus.AwaitingPayment)}");
            }
            else
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏: {ex.Message}";
            NotificationService.ShowError(errorMessage);
        }
    }

    private async Task CloseOrder()
    {
        errorMessage = string.Empty;
        NotificationService.Clear();

        try
        {
            var command = new ChangeOrderStatusCommand(orderModel.Id, OrderStatus.Closed);
            var success = await ApiService.ChangeOrderStatus(command);

            if (success)
            {
                // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ UI
                orderModel.Status = OrderStatus.Closed;
                NotificationService.ShowInfo("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞.");
            }
            else
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞—è–≤–∫–∏: {ex.Message}";
            NotificationService.ShowError(errorMessage);
        }
    }

    private async Task ChangeStatus()
    {
        errorMessage = string.Empty;
        NotificationService.Clear();

        try
        {
            var command = new ChangeOrderStatusCommand(orderModel.Id, selectedStatus);
            var success = await ApiService.ChangeOrderStatus(command);

            if (success)
            {
                // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ UI
                orderModel.Status = selectedStatus;
                NotificationService.ShowInfo($"–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {GetOrderStatusDescription(selectedStatus)}");
            }
            else
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏: {ex.Message}";
            NotificationService.ShowError(errorMessage);
        }
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteConfirmDialog = true;
    }

    private async Task ConfirmDelete()
    {
        showDeleteConfirmDialog = false;
        errorMessage = string.Empty;
        NotificationService.Clear();

        try
        {
            var success = await ApiService.DeleteOrder(OrderId ?? 0);

            if (success)
            {
                NotificationService.ShowInfo("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.");
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: {ex.Message}";
            NotificationService.ShowError(errorMessage);
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirmDialog = false;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (isLocked)
            {
                isLocked = await ApiService.ResetLockedOrder(OrderId ?? 0);
            }
        }
        catch
        {
            // ignore unlock failures
        }
    }
}


