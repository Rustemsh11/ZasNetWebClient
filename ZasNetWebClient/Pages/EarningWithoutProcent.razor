@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using Microsoft.JSInterop
@inject ApiService ApiService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime

<div class="employee-earnings-container" @onclick="CloseAllDropdowns">
    <div class="page-header">
        <div class="header-content">
            <div>
                <h1>–ó–∞—Ä–ø–ª–∞—Ç–∞ –±–µ–∑ –∑–∞—è–≤–∫–∏</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç–∞–º–∏ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∑–∞—è–≤–∫–∞–º</p>
            </div>
            <button class="btn-primary" @onclick="OpenCreateDialog">
                –î–æ–±–∞–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-header">
            <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
            <button class="btn-secondary btn-compact" @onclick="async () => await ClearFilters()">
                –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ
            </button>
        </div>
        
        <div class="filters-grid">
            <!-- Date range filter -->
            <div class="filter-group">
                <label for="date-from">–î–∞—Ç–∞ –æ—Ç</label>
                <input type="date" 
                       id="date-from"
                       class="form-control" 
                       value="@(filterDateFrom?.ToString("yyyy-MM-dd"))"
                       @onchange="async (e) => { filterDateFrom = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value!.ToString()!); await ApplyFilters(); }" />
            </div>

            <div class="filter-group">
                <label for="date-to">–î–∞—Ç–∞ –¥–æ</label>
                <input type="date" 
                       id="date-to"
                       class="form-control" 
                       value="@(filterDateTo?.ToString("yyyy-MM-dd"))"
                       @onchange="async (e) => { filterDateTo = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value!.ToString()!); await ApplyFilters(); }" />
            </div>

            <!-- Employee filter -->
            <div class="filter-group filter-group-employees">
                <label for="employee-dropdown">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</label>
                <div class="custom-dropdown">
                    <button type="button" 
                            class="dropdown-toggle form-control" 
                            @onclick="ToggleEmployeeDropdown"
                            @onclick:stopPropagation="true">
                        <span class="dropdown-text">
                            @if (selectedEmployeeIds.Any())
                            {
                                <text>–í—ã–±—Ä–∞–Ω–æ: @selectedEmployeeIds.Count</text>
                            }
                            else
                            {
                                <text>–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</text>
                            }
                        </span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    
                    @if (showEmployeeDropdown)
                    {
                        <div class="dropdown-menu" @onclick:stopPropagation="true">
                            @if (allEmployees.Any())
                            {
                                <div class="dropdown-search">
                                    <input type="text" 
                                           class="form-control" 
                                           placeholder="–ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..."
                                           value="@employeeSearchTerm"
                                           @oninput="(e) => employeeSearchTerm = e.Value?.ToString() ?? string.Empty"
                                           @onclick:stopPropagation="true" />
                                </div>
                                <div class="dropdown-items">
                                    @foreach (var employee in GetFilteredEmployees())
                                    {
                                        <label class="dropdown-item-checkbox" @onclick:stopPropagation="true">
                                            <input type="checkbox" 
                                                   checked="@selectedEmployeeIds.Contains(employee.Id)"
                                                   @onchange="(e) => ToggleEmployeeSelection(employee.Id, ((ChangeEventArgs)e).Value)"
                                                   @onclick:stopPropagation="true" />
                                            <span>@employee.Name</span>
                                        </label>
                                    }
                                </div>
                                <div class="dropdown-footer">
                                    <button type="button" 
                                            class="btn-secondary btn-compact" 
                                            @onclick="ClearEmployeeFilter"
                                            @onclick:stopPropagation="true">
                                        –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                                    </button>
                                    <button type="button" 
                                            class="btn-primary btn-compact" 
                                            @onclick="ApplyEmployeesFilter"
                                            @onclick:stopPropagation="true">
                                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="dropdown-empty">
                                    <span>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Active filters display -->
        @if (HasActiveFilters())
        {
            <div class="active-filters">
                <span class="active-filters-label">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</span>
                <div class="active-filters-list">
                    @if (filterDateFrom.HasValue)
                    {
                        <span class="filter-tag">
                            –î–∞—Ç–∞ –æ—Ç: @filterDateFrom.Value.ToString("dd.MM.yyyy")
                            <button @onclick="async () => { filterDateFrom = null; await ApplyFilters(); }">&times;</button>
                        </span>
                    }
                    @if (filterDateTo.HasValue)
                    {
                        <span class="filter-tag">
                            –î–∞—Ç–∞ –¥–æ: @filterDateTo.Value.ToString("dd.MM.yyyy")
                            <button @onclick="async () => { filterDateTo = null; await ApplyFilters(); }">&times;</button>
                        </span>
                    }
                    @if (selectedEmployeeIds.Any())
                    {
                        @foreach (var employeeId in selectedEmployeeIds)
                        {
                            var employeeName = allEmployees.FirstOrDefault(e => e.Id == employeeId)?.Name ?? "";
                            <span class="filter-tag">
                                –°–æ—Ç—Ä—É–¥–Ω–∏–∫: @employeeName
                                <button @onclick="async () => await RemoveEmployee(employeeId)">&times;</button>
                            </span>
                        }
                    }
                </div>
            </div>
        }
    </div>

    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
    }
    else if (earnings.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-state-icon">üí∞</div>
            <h3>–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p>
                @if (HasActiveFilters())
                {
                    <text>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</text>
                }
                else
                {
                    <text>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –∑–∞—Ä–ø–ª–∞—Ç–µ –±–µ–∑ –∑–∞—è–≤–æ–∫</text>
                }
            </p>
            <button class="btn-primary" @onclick="OpenCreateDialog">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>
    }
    else
    {
        <!-- Results summary -->
        <div class="results-summary">
            <div class="results-info">
                <span>–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: <strong>@earnings.Count</strong></span>
                <span class="total-earnings">–û–±—â–∞—è —Å—É–º–º–∞: <strong>@totalEarnings.ToString("C")</strong></span>
            </div>
        </div>

        <!-- Earnings Table -->
        <div class="earnings-table-container">
            <table class="earnings-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var earning in earnings)
                    {
                        <tr class="earning-row">
                            <td class="date-cell">@earning.DateTime.ToString("dd.MM.yyyy")</td>
                            <td class="employee-cell">
                                <span class="employee-icon">üë§</span>
                                <span>@earning.EmployeeName</span>
                            </td>
                            <td class="earning-cell">@earning.Price.ToString("C")</td>
                            <td class="description-cell">
                                @if (!string.IsNullOrEmpty(earning.Description))
                                {
                                    <span title="@earning.Description">@earning.Description</span>
                                }
                                else
                                {
                                    <span class="empty-description">‚Äî</span>
                                }
                            </td>
                            <td class="action-cell">
                                <div class="action-buttons">
                                    <button class="btn-icon btn-edit" 
                                            @onclick="() => OpenEditDialog(earning)" 
                                            @onclick:stopPropagation="true"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        ‚úèÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Edit Modal -->
@if (showDialog)
{
    <div class="modal-overlay">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(isEditMode ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" : "–î–æ–±–∞–≤–∏—Ç—å") –∑–∞—Ä–ø–ª–∞—Ç—É</h2>
                <button class="modal-close" @onclick="CloseDialog">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label for="edit-employee">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ *</label>
                        <select id="edit-employee" 
                                class="form-control" 
                                @bind="editingEarning.EmployeeId"
                                disabled="@isEditMode">
                            <option value="0">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
                            @foreach (var employee in allEmployees)
                            {
                                <option value="@employee.Id">@employee.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-date">–î–∞—Ç–∞ *</label>
                        <input type="date" 
                               id="edit-date"
                               class="form-control" 
                               value="@editingEarning.DateTime.ToString("yyyy-MM-dd")"
                               @onchange="@OnDateChanged" />
                    </div>

                    <div class="form-group">
                        <label for="edit-price">–°—É–º–º–∞ (‚ÇΩ) *</label>
                        <input type="number" 
                               id="edit-price"
                               step="0.01" 
                               min="0"
                               class="form-control" 
                               value="@editingEarning.Price" 
                               @onchange="@OnPriceChanged" 
                               placeholder="0.00" />
                    </div>

                    <div class="form-group">
                        <label for="edit-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="edit-description" 
                                  class="form-control" 
                                  rows="3"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..."
                                  @bind="editingEarning.Description"></textarea>
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <div class="error-message">
                        ‚ö†Ô∏è @errorMessage
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseDialog" disabled="@isSaving">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button class="btn-primary" @onclick="SaveEarning" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-small"></span>
                        <text>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</text>
                    }
                    else
                    {
                        <text>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</text>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<EarningWithoutProcentDto> earnings = new();
    private List<EmployeeDto> allEmployees = new();
    
    private bool isLoading = false;
    private bool showDialog = false;
    private bool isEditMode = false;
    private bool showEmployeeDropdown = false;
    private bool isSaving = false;
    private decimal totalEarnings = 0;

    // Filters
    private DateTime? filterDateFrom = null;
    private DateTime? filterDateTo = null;
    private List<int> selectedEmployeeIds = new();
    private string employeeSearchTerm = string.Empty;

    // Editing
    private EarningWithoutProcentDto editingEarning = new();
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            await Task.WhenAll(
                LoadEmployees(),
                LoadEarnings()
            );
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadEmployees()
    {
        allEmployees = await ApiService.GetEmployees();
    }

    private async Task LoadEarnings()
    {
        var request = new GetEarningWithoutProcentByFilterRequest
        {
            DateFrom = filterDateFrom,
            DateTo = filterDateTo,
            EmployeeIds = selectedEmployeeIds.Any() ? selectedEmployeeIds : null
        };

        earnings = await ApiService.GetEarningsWithoutProcent(request);
        totalEarnings = earnings.Sum(e => e.Price);
    }

    private async Task ApplyFilters()
    {
        isLoading = true;
        try
        {
            await LoadEarnings();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearFilters()
    {
        filterDateFrom = null;
        filterDateTo = null;
        selectedEmployeeIds.Clear();
        employeeSearchTerm = string.Empty;
        showEmployeeDropdown = false;
        await ApplyFilters();
    }

    private bool HasActiveFilters()
    {
        return filterDateFrom.HasValue ||
               filterDateTo.HasValue ||
               selectedEmployeeIds.Any();
    }

    private void ToggleEmployeeDropdown()
    {
        showEmployeeDropdown = !showEmployeeDropdown;
        if (!showEmployeeDropdown)
        {
            employeeSearchTerm = string.Empty;
        }
    }

    private void ToggleEmployeeSelection(int employeeId, object? checkedValue)
    {
        var isChecked = checkedValue is bool b && b;
        
        if (isChecked)
        {
            if (!selectedEmployeeIds.Contains(employeeId))
            {
                selectedEmployeeIds.Add(employeeId);
            }
        }
        else
        {
            selectedEmployeeIds.Remove(employeeId);
        }
    }

    private async Task RemoveEmployee(int employeeId)
    {
        selectedEmployeeIds.Remove(employeeId);
        await ApplyFilters();
    }

    private async Task ApplyEmployeesFilter()
    {
        showEmployeeDropdown = false;
        employeeSearchTerm = string.Empty;
        await ApplyFilters();
    }

    private void ClearEmployeeFilter()
    {
        selectedEmployeeIds.Clear();
        showEmployeeDropdown = false;
        employeeSearchTerm = string.Empty;
    }

    private List<EmployeeDto> GetFilteredEmployees()
    {
        if (string.IsNullOrWhiteSpace(employeeSearchTerm))
        {
            return allEmployees;
        }

        return allEmployees
            .Where(e => e.Name.Contains(employeeSearchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void CloseAllDropdowns()
    {
        if (showEmployeeDropdown)
        {
            showEmployeeDropdown = false;
            employeeSearchTerm = string.Empty;
        }
    }

    private void OpenCreateDialog()
    {
        isEditMode = false;
        showDialog = true;
        errorMessage = string.Empty;
        editingEarning = new EarningWithoutProcentDto
        {
            DateTime = DateTime.Now,
            Price = 0
        };
    }

    private void OpenEditDialog(EarningWithoutProcentDto earning)
    {
        isEditMode = true;
        showDialog = true;
        errorMessage = string.Empty;
        editingEarning = new EarningWithoutProcentDto
        {
            Id = earning.Id,
            EmployeeId = earning.EmployeeId,
            EmployeeName = earning.EmployeeName,
            DateTime = earning.DateTime,
            Price = earning.Price,
            Description = earning.Description
        };
    }

    private void CloseDialog()
    {
        showDialog = false;
        errorMessage = string.Empty;
        isSaving = false;
    }

    private async Task SaveEarning()
    {
        // Validation
        if (editingEarning.EmployeeId == 0)
        {
            errorMessage = "–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
            return;
        }

        if (editingEarning.Price <= 0)
        {
            errorMessage = "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É";
            return;
        }

        isSaving = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            bool success = false;

            if (isEditMode)
            {
                var command = new UpdateEarningWithoutProcentCommand
                {
                    Id = editingEarning.Id,
                    EmployeeId = editingEarning.EmployeeId,
                    DateTime = editingEarning.DateTime,
                    Price = editingEarning.Price,
                    Description = editingEarning.Description
                };
                success = await ApiService.UpdateEarningWithoutProcent(command);
            }
            else
            {
                var command = new CreateEarningWithoutProcentCommand
                {
                    EmployeeId = editingEarning.EmployeeId,
                    DateTime = editingEarning.DateTime,
                    Price = editingEarning.Price,
                    Description = editingEarning.Description
                };
                success = await ApiService.CreateEarningWithoutProcent(command);
            }

            if (success)
            {
                NotificationService.ShowInfo(isEditMode ? "–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ" : "–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
                CloseDialog();
                await LoadEarnings();
            }
            else
            {
                errorMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving earning: {ex.Message}");
            errorMessage = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void OnDateChanged(ChangeEventArgs e)
    {
        var dateStr = e.Value?.ToString();
        editingEarning.DateTime = !string.IsNullOrEmpty(dateStr) ? DateTime.Parse(dateStr) : DateTime.Now;
    }

    private void OnPriceChanged(ChangeEventArgs e)
    {
        var priceStr = e.Value?.ToString();
        if (!string.IsNullOrEmpty(priceStr) && decimal.TryParse(priceStr, out var price))
        {
            editingEarning.Price = price;
        }
    }
}

