@page "/structure"
@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using Microsoft.JSInterop
@inject ApiService ApiService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime

<div class="structure-container">
    <aside class="structure-sidebar">
        <h3 class="sidebar-title">–°—É—â–Ω–æ—Å—Ç–∏</h3>
        <nav class="entity-menu">
            <button class="entity-item @(selectedEntity == "Car" ? "active" : "")" @onclick='() => SelectEntity("Car")'>
                <span class="entity-icon">üöó</span>
                <span>–ú–∞—à–∏–Ω—ã</span>
            </button>
            <button class="entity-item @(selectedEntity == "CarModel" ? "active" : "")" @onclick='() => SelectEntity("CarModel")'>
                <span class="entity-icon">üè∑Ô∏è</span>
                <span>–ú–æ–¥–µ–ª–∏ –º–∞—à–∏–Ω</span>
            </button>
            <button class="entity-item @(selectedEntity == "Employee" ? "active" : "")" @onclick='() => SelectEntity("Employee")'>
                <span class="entity-icon">üë§</span>
                <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
            </button>
            <button class="entity-item @(selectedEntity == "Service" ? "active" : "")" @onclick='() => SelectEntity("Service")'>
                <span class="entity-icon">üõ†Ô∏è</span>
                <span>–£—Å–ª—É–≥–∏</span>
            </button>
            <button class="entity-item @(selectedEntity == "Role" ? "active" : "")" @onclick='() => SelectEntity("Role")'>
                <span class="entity-icon">üé≠</span>
                <span>–†–æ–ª–∏</span>
            </button>
            <button class="entity-item @(selectedEntity == "Measure" ? "active" : "")" @onclick='() => SelectEntity("Measure")'>
                <span class="entity-icon">üìè</span>
                <span>–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</span>
            </button>
        </nav>
    </aside>

    <main class="structure-content">
        <div class="content-header">
            <h2 class="content-title">@GetEntityTitle()</h2>
            <button class="btn btn-primary" @onclick="OpenCreateDialog">
                <span class="btn-icon">+</span>
                –î–æ–±–∞–≤–∏—Ç—å
            </button>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        }
        else
        {
            <div class="entity-list">
                @switch (selectedEntity)
                {
                    case "Car":
                        @foreach (var item in cars)
                        {
                            <div class="entity-card">
                                <div class="card-content">
                                    <h4>@item.Number</h4>
                                    <p class="card-details">–ú–æ–¥–µ–ª—å: @(item.CarModel?.Name ?? "–ù–µ —É–∫–∞–∑–∞–Ω–∞")</p>
                                    <p class="card-details">–°—Ç–∞—Ç—É—Å: @GetCarStatus(item.Status)</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-icon-action edit" @onclick="() => OpenEditDialog(item)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="btn-icon-action delete" @onclick="() => DeleteEntity(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                </div>
                            </div>
                        }
                        break;

                    case "CarModel":
                        @foreach (var item in carModels)
                        {
                            <div class="entity-card">
                                <div class="card-content">
                                    <h4>@item.Name</h4>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-icon-action edit" @onclick="() => OpenEditDialog(item)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="btn-icon-action delete" @onclick="() => DeleteEntity(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                </div>
                            </div>
                        }
                        break;

                    case "Employee":
                        @foreach (var item in employees)
                        {
                            <div class="entity-card">
                                <div class="card-content">
                                    <h4>@item.Name</h4>
                                    <p class="card-details">–õ–æ–≥–∏–Ω: @(item.Login ?? "–ù–µ —É–∫–∞–∑–∞–Ω")</p>
                                    <p class="card-details">–†–æ–ª—å: @(item.Role?.Name ?? "–ù–µ —É–∫–∞–∑–∞–Ω–∞")</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-icon-action edit" @onclick="() => OpenEditDialog(item)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="btn-icon-action delete" @onclick="() => DeleteEntity(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                </div>
                            </div>
                        }
                        break;

                    case "Service":
                        @foreach (var item in services)
                        {
                            <div class="entity-card">
                                <div class="card-content">
                                    <h4>@item.Name</h4>
                                    <p class="card-details">–ú–∏–Ω. —Ü–µ–Ω–∞: @item.MinPrice.ToString("N2") ‚ÇΩ</p>
                                    <p class="card-details">–ú–∏–Ω. –æ–±—ä–µ–º: @item.MinVolume @item.Measure</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-icon-action edit" @onclick="() => OpenEditDialog(item)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="btn-icon-action delete" @onclick="() => DeleteEntity(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                </div>
                            </div>
                        }
                        break;

                    case "Role":
                        @foreach (var item in roles)
                        {
                            <div class="entity-card">
                                <div class="card-content">
                                    <h4>@item.Name</h4>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-icon-action edit" @onclick="() => OpenEditDialog(item)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="btn-icon-action delete" @onclick="() => DeleteEntity(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                </div>
                            </div>
                        }
                        break;

                    case "Measure":
                        @foreach (var item in measures)
                        {
                            <div class="entity-card">
                                <div class="card-content">
                                    <h4>@item.Name</h4>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-icon-action edit" @onclick="() => OpenEditDialog(item)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="btn-icon-action delete" @onclick="() => DeleteEntity(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                </div>
                            </div>
                        }
                        break;
                }

                @if (GetCurrentList().Count == 0)
                {
                    <div class="empty-state">
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                        <button class="btn btn-primary" @onclick="OpenCreateDialog">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å</button>
                    </div>
                }
            </div>
        }
    </main>
</div>

@if (showDialog)
{
    <div class="modal-overlay">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditMode ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" : "–î–æ–±–∞–≤–∏—Ç—å") @GetEntityTitle()</h3>
                <button class="btn-close" @onclick="CloseDialog">√ó</button>
            </div>
            <div class="modal-body">
                @switch (selectedEntity)
                {
                    case "Car":
                        <div class="form-group">
                            <label>–ù–æ–º–µ—Ä –º–∞—à–∏–Ω—ã *</label>
                            <input type="text" class="form-control" @bind="editingCar.Number" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä" />
                        </div>
                        <div class="form-group">
                            <label>–ú–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã *</label>
                            <select class="form-control" @bind="editingCar.CarModel.Id">
                                <option value="0">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>
                                @foreach (var model in carModels)
                                {
                                    <option value="@model.Id">@model.Name</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-control" @bind="editingCar.Status">
                                <option value="0">–ê–∫—Ç–∏–≤–Ω–∞</option>
                                <option value="1">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</option>
                            </select>
                        </div>
                        break;

                    case "CarModel":
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ *</label>
                            <input type="text" class="form-control" @bind="editingCarModel.Name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" />
                        </div>
                        break;

                    case "Employee":
                        <div class="form-group">
                            <label>–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ *</label>
                            <input type="text" class="form-control" @bind="editingEmployee.Name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" />
                        </div>
                        <div class="form-group">
                            <label>–õ–æ–≥–∏–Ω *</label>
                            <input type="text" class="form-control" @bind="editingEmployee.Login" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" />
                        </div>
                        <div class="form-group">
                            <label>–ü–∞—Ä–æ–ª—å @(isEditMode ? "" : "*")</label>
                            <input id="password" type="password" class="form-control" @bind="editingEmployee.Password" placeholder="@(isEditMode ? "–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" : "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å")" />
                        </div>
                        <div class="form-group">
                            <label>–†–æ–ª—å *</label>
                            <select class="form-control" @bind="editingEmployee.Role.Id">
                                <option value="0">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                                @foreach (var role in roles)
                                {
                                    <option value="@role.Id">@role.Name</option>
                                }
                            </select>
                        </div>
                        @if (IsDispetcherRoleSelected())
                        {
                            <div class="form-group">
                                <label>–ü—Ä–æ—Ü–µ–Ω—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ (%)</label>
                                <input type="number" step="0.01" class="form-control" @bind="editingEmployee.DispetcherProcent" placeholder="0.00" />
                            </div>
                        }
                        break;

                    case "Service":
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ *</label>
                            <input type="text" class="form-control" @bind="editingService.Name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" />
                        </div>
                        <div class="form-group">
                            <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ *</label>
                            <input type="number" step="0.01" class="form-control" @bind="editingService.MinPrice" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º *</label>
                            <input type="number" step="0.01" class="form-control" @bind="editingService.MinVolume" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
                            <select class="form-control" @bind="editingServiceMeasureId">
                                <option value="0">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É</option>
                                @foreach (var measure in measures)
                                {
                                    <option value="@measure.Id">@measure.Name</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç) *</label>
                            <input type="number" step="0.01" class="form-control" @bind="editingService.StandartPrecentForEmployee" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ *</label>
                            <input type="number" step="0.01" class="form-control" @bind="editingService.PrecentForMultipleEmployeers" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –ø–æ–∑–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞ (–æ–¥–∏–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫) *</label>
                            <input type="number" step="0.01" class="form-control" @bind="editingService.PrecentLaterOrderForEmployee" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –ø–æ–∑–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤) *</label>
                            <input type="number" step="0.01" class="form-control" @bind="editingService.PrecentLaterOrderForMultipleEmployeers" placeholder="0.00" />
                        </div>
                        break;

                    case "Role":
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ *</label>
                            <input type="text" class="form-control" @bind="editingRole.Name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" />
                        </div>
                        break;

                    case "Measure":
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
                            <input type="text" class="form-control" @bind="editingMeasure.Name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" />
                        </div>
                        break;
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseDialog">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" @onclick="SaveEntity">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
}

@code {
    private string selectedEntity = "Car";
    private bool isLoading = false;
    private bool showDialog = false;
    private bool isEditMode = false;

    // Data lists
    private List<CarDto> cars = new();
    private List<CarModelDto> carModels = new();
    private List<EmployeeDto> employees = new();
    private List<ServiceDto> services = new();
    private List<RoleDto> roles = new();
    private List<MeasureDto> measures = new();

    // Editing entities
    private CarDto editingCar = new();
    private CarModelDto editingCarModel = new();
    private EmployeeDto editingEmployee = new();
    private ServiceDto editingService = new();
    private RoleDto editingRole = new();
    private MeasureDto editingMeasure = new();
    private int editingServiceMeasureId = 0;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ö–µ—à –ø–∞—Ä–æ–ª—è –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    private string? originalEmployeePasswordHash = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadAllData();
    }

    private async Task LoadAllData()
    {
        isLoading = true;
        try
        {
            var tasks = new List<Task>
            {
                LoadCars(),
                LoadCarModels(),
                LoadEmployees(),
                LoadServices(),
                LoadRoles(),
                LoadMeasures()
            };
            await Task.WhenAll(tasks);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SelectEntity(string entity)
    {
        selectedEntity = entity;
        await LoadEntityData();
    }

    private async Task LoadEntityData()
    {
        isLoading = true;
        try
        {
            switch (selectedEntity)
            {
                case "Car":
                    await LoadCars();
                    break;
                case "CarModel":
                    await LoadCarModels();
                    break;
                case "Employee":
                    await LoadEmployees();
                    break;
                case "Service":
                    await LoadServices();
                    break;
                case "Role":
                    await LoadRoles();
                    break;
                case "Measure":
                    await LoadMeasures();
                    break;
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCars()
    {
        cars = await ApiService.GetCars();
    }

    private async Task LoadCarModels()
    {
        carModels = await ApiService.GetCarModels();
    }

    private async Task LoadEmployees()
    {
        employees = await ApiService.GetEmployees();
    }

    private async Task LoadServices()
    {
        services = await ApiService.GetServices();
    }

    private async Task LoadRoles()
    {
        roles = await ApiService.GetRoles();
    }

    private async Task LoadMeasures()
    {
        measures = await ApiService.GetMeasures();
    }

    private void OpenCreateDialog()
    {
        isEditMode = false;
        showDialog = true;
        
        // Reset editing entities
        editingCar = new CarDto();
        editingCarModel = new CarModelDto();
        editingEmployee = new EmployeeDto();
        editingService = new ServiceDto();
        editingRole = new RoleDto();
        editingMeasure = new MeasureDto();
        editingServiceMeasureId = 0;
        originalEmployeePasswordHash = null;
    }

    private void OpenEditDialog(object entity)
    {
        isEditMode = true;
        showDialog = true;

        switch (selectedEntity)
        {
            case "Car":
                var car = (CarDto)entity;
                editingCar = new CarDto
                {
                    Id = car.Id,
                    Number = car.Number,
                    Status = car.Status,
                    CarModel = car.CarModel
                };
                break;
            case "CarModel":
                var carModel = (CarModelDto)entity;
                editingCarModel = new CarModelDto { Id = carModel.Id, Name = carModel.Name };
                break;
            case "Employee":
                var employee = (EmployeeDto)entity;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ö–µ—à –ø–∞—Ä–æ–ª—è
                originalEmployeePasswordHash = employee.Password;
                editingEmployee = new EmployeeDto
                {
                    Id = employee.Id,
                    Name = employee.Name,
                    Login = employee.Login,
                    Password = "", // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    Role = employee.Role,
                    DispetcherProcent = employee.DispetcherProcent
                };
                break;
            case "Service":
                var service = (ServiceDto)entity;
                editingService = new ServiceDto
                {
                    Id = service.Id,
                    Name = service.Name,
                    MinPrice = service.MinPrice,
                    MinVolume = service.MinVolume,
                    Measure = service.Measure,
                    StandartPrecentForEmployee = service.StandartPrecentForEmployee,
                    PrecentForMultipleEmployeers = service.PrecentForMultipleEmployeers,
                    PrecentLaterOrderForEmployee = service.PrecentLaterOrderForEmployee,
                    PrecentLaterOrderForMultipleEmployeers = service.PrecentLaterOrderForMultipleEmployeers
                };
                // Find measure ID by name
                var measureForService = measures.FirstOrDefault(m => m.Name == service.Measure);
                editingServiceMeasureId = measureForService?.Id ?? 0;
                break;
            case "Role":
                var role = (RoleDto)entity;
                editingRole = new RoleDto { Id = role.Id, Name = role.Name };
                break;
            case "Measure":
                var measure = (MeasureDto)entity;
                editingMeasure = new MeasureDto { Id = measure.Id, Name = measure.Name };
                break;
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
    }

    private async Task SaveEntity()
    {
        try
        {
            bool success = false;

            switch (selectedEntity)
            {
                case "Car":
                    if (string.IsNullOrWhiteSpace(editingCar.Number) || editingCar.CarModel.Id == 0)
                    {
                        NotificationService.ShowError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                        return;
                    }
                    success = isEditMode 
                        ? await ApiService.UpdateCar(editingCar)
                        : await ApiService.CreateCar(editingCar);
                    if (success) await LoadCars();
                    break;

                case "CarModel":
                    if (string.IsNullOrWhiteSpace(editingCarModel.Name))
                    {
                        NotificationService.ShowError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                        return;
                    }
                    success = isEditMode
                        ? await ApiService.UpdateCarModel(editingCarModel)
                        : await ApiService.CreateCarModel(editingCarModel);
                    if (success) await LoadCarModels();
                    break;

                case "Employee":
                    if (string.IsNullOrWhiteSpace(editingEmployee.Name) || 
                        string.IsNullOrWhiteSpace(editingEmployee.Login) ||
                        editingEmployee.Role.Id == 0 ||
                        (!isEditMode && string.IsNullOrWhiteSpace(editingEmployee.Password)))
                        {
                            NotificationService.ShowError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                            return;
                        }
                    
                    // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–∞—Ä–æ–ª—å –Ω–µ –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ö–µ—à
                    if (isEditMode && string.IsNullOrWhiteSpace(editingEmployee.Password))
                    {
                        editingEmployee.Password = null;
                    }
                    
                    success = isEditMode
                        ? await ApiService.UpdateEmployee(editingEmployee)
                        : await ApiService.CreateEmployee(editingEmployee);
                    if (success) await LoadEmployees();
                    break;

                case "Service":
                    if (string.IsNullOrWhiteSpace(editingService.Name) || 
                        editingServiceMeasureId == 0)
                    {
                        NotificationService.ShowError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                        return;
                    }
                    success = isEditMode
                        ? await ApiService.UpdateService(editingService, editingServiceMeasureId)
                        : await ApiService.CreateService(editingService, editingServiceMeasureId);
                    if (success) await LoadServices();
                    break;

                case "Role":
                    if (string.IsNullOrWhiteSpace(editingRole.Name))
                    {
                        NotificationService.ShowError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                        return;
                    }
                    success = isEditMode
                        ? await ApiService.UpdateRole(editingRole)
                        : await ApiService.CreateRole(editingRole);
                    if (success) await LoadRoles();
                    break;

                case "Measure":
                    if (string.IsNullOrWhiteSpace(editingMeasure.Name))
                    {
                        NotificationService.ShowError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                        return;
                    }
                    success = isEditMode
                        ? await ApiService.UpdateMeasure(editingMeasure)
                        : await ApiService.CreateMeasure(editingMeasure);
                    if (success) await LoadMeasures();
                    break;
            }

            if (success)
            {
                NotificationService.ShowInfo(isEditMode ? "–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ" : "–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
                CloseDialog();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"–û—à–∏–±–∫–∞: {ex.Message}");
        }
    }

    private async Task DeleteEntity(int id)
    {
        if (!await JSConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?"))
            return;

        try
        {
            bool success = false;

            switch (selectedEntity)
            {
                case "Car":
                    success = await ApiService.DeleteCar(id);
                    if (success) await LoadCars();
                    break;
                case "CarModel":
                    success = await ApiService.DeleteCarModel(id);
                    if (success) await LoadCarModels();
                    break;
                case "Employee":
                    success = await ApiService.DeleteEmployee(id);
                    if (success) await LoadEmployees();
                    break;
                case "Service":
                    success = await ApiService.DeleteService(id);
                    if (success) await LoadServices();
                    break;
                case "Role":
                    success = await ApiService.DeleteRole(id);
                    if (success) await LoadRoles();
                    break;
                case "Measure":
                    success = await ApiService.DeleteMeasure(id);
                    if (success) await LoadMeasures();
                    break;
            }

            if (success)
            {
                NotificationService.ShowInfo("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
            }
            else
            {
                NotificationService.ShowError("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"–û—à–∏–±–∫–∞: {ex.Message}");
        }
    }

    private string GetEntityTitle()
    {
        return selectedEntity switch
        {
            "Car" => "–ú–∞—à–∏–Ω—ã",
            "CarModel" => "–ú–æ–¥–µ–ª–∏ –º–∞—à–∏–Ω",
            "Employee" => "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",
            "Service" => "–£—Å–ª—É–≥–∏",
            "Role" => "–†–æ–ª–∏",
            "Measure" => "–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è",
            _ => ""
        };
    }

    private string GetCarStatus(int status)
    {
        return status switch
        {
            0 => "–ê–∫—Ç–∏–≤–Ω–∞",
            1 => "–ù–µ–∞–∫—Ç–∏–≤–Ω–∞",
            _ => "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        };
    }

    private List<object> GetCurrentList()
    {
        return selectedEntity switch
        {
            "Car" => cars.Cast<object>().ToList(),
            "CarModel" => carModels.Cast<object>().ToList(),
            "Employee" => employees.Cast<object>().ToList(),
            "Service" => services.Cast<object>().ToList(),
            "Role" => roles.Cast<object>().ToList(),
            "Measure" => measures.Cast<object>().ToList(),
            _ => new List<object>()
        };
    }

    private async Task<bool> JSConfirm(string message)
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", message);
    }

    private bool IsDispetcherRoleSelected()
    {
        if (editingEmployee?.Role == null || editingEmployee.Role.Id == 0)
            return false;

        var selectedRole = roles.FirstOrDefault(r => r.Id == editingEmployee.Role.Id);
        return selectedRole != null && selectedRole.Name.Equals("–î–∏—Å–ø–µ—Ç—á–µ—Ä", StringComparison.OrdinalIgnoreCase);
    }
}

