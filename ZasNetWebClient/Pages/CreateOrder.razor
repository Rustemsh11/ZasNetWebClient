@page "/create-order"
@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using ZasNetWebClient.Components
@inject ApiService ApiService
@inject NavigationManager Navigation

<PageTitle>Создание заявки - ZasNet</PageTitle>

    <div class="page-header-compact">
        <h1>Создание новой заявки</h1>
    </div>

    <div class="create-form-container-compact">
        <EditForm Model="@orderModel" OnValidSubmit="@HandleSubmit">
            <DataAnnotationsValidator />
            
            <div class="form-section">
                <h3>Информация клиента</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client">Название клиента</label>
                        <InputText id="client" @bind-Value="orderModel.Client" class="form-control" placeholder="введите клиента" />
                        <ValidationMessage For="@(() => orderModel.Client)" />
                    </div>
                    <div class="form-group">
                        <label for="date">Дата</label>
                        <InputDate id="date" @bind-Value="orderModel.Date" class="form-control" />
                        <ValidationMessage For="@(() => orderModel.Date)" />
                    </div>
                    <div class="form-group">
                        <label for="payment">Вид оплаты</label>
                        <InputSelect id="payment" @bind-Value="orderModel.PaymentType" class="form-control">
                            <option value="@PaymentType.Cash">Наличные</option>
                            <option value="@PaymentType.Card">Карта</option>
                            <option value="@PaymentType.Electronic">СБП</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => orderModel.PaymentType)" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">Город</label>
                        <InputText id="city" @bind-Value="orderModel.AddressCity" class="form-control" placeholder="введите город"/>
                        <ValidationMessage For="@(() => orderModel.AddressCity)" />
                    </div>
                    <div class="form-group">
                        <label for="street">Улица</label>
                        <InputText id="street" @bind-Value="orderModel.AddressStreet" class="form-control" placeholder="введите улицу" />
                        <ValidationMessage For="@(() => orderModel.AddressStreet)" />
                    </div>
                    <div class="form-group">
                        <label for="number">Номер дома</label>
                        <InputText id="number" @bind-Value="orderModel.AddressNumber" class="form-control" placeholder="введите номер дома" />
                        <ValidationMessage For="@(() => orderModel.AddressNumber)" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Доп. информация</label>
                    <InputTextArea id="description" @bind-Value="orderModel.Description" class="form-control" placeholder="введите доп. информацию" rows="1" />
                </div>
            </div>

            <div class="form-section">
                <h3>Информация заявки</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Общая стоимость заявки</label>
                        <InputNumber id="price" @bind-Value="orderModel.OrderPriceAmount" class="form-control" />
                    <ValidationMessage For="@(() => orderModel.OrderPriceAmount)" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <div class="services-header">
                            <label>Ответственный сотрудник</label>
                            <button type="button" class="btn-primary" @onclick="ShowEmployeeDialog">
                                <span>+</span> Выбрать
                            </button>
                        </div>
                        <div class="selection-container">
                            @if (orderModel.OrderEmployeeIds.Any())
                            {
                                <div class="selected-items">
                                    @foreach (var employeeId in orderModel.OrderEmployeeIds)
                                    {
                                        var employee = availableEmployees.FirstOrDefault(e => e.Id == employeeId);
                                        if (employee != null)
                                        {
                                            <span class="selected-item">
                                                @employee.Name
                                                <button type="button" class="btn-remove-item" @onclick="() => RemoveEmployee(employeeId)">&times;</button>
                                            </span>
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-selection">Работники не выбраны</div>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="services-header">
                            <label>Выездные машины</label>
                            <button type="button" class="btn-primary" @onclick="ShowCarDialog">
                                <span>+</span> Выбрать
                            </button>
                        </div>
                        <div class="selection-container">
                            @if (orderModel.OrderCarIds.Any())
                            {
                                <div class="selected-items">
                                    @foreach (var carId in orderModel.OrderCarIds)
                                    {
                                        var car = availableCars.FirstOrDefault(c => c.Id == carId);
                                        if (car != null)
                                        {
                                            <span class="selected-item">
                                                @car.Name
                                                <button type="button" class="btn-remove-item" @onclick="() => RemoveCar(carId)">&times;</button>
                                            </span>
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-selection">Машины не выбраны</div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="services-header">
                    <h3>Услуги</h3>
                    <button type="button" class="btn-primary" @onclick="ShowServiceDialog">
                        <span>+</span> Добавить
                    </button>
                </div>
                
                @if (orderModel.OrderServicesDto.Any())
                {
                    <table class="services-table">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Цена</th>
                                <th>Объем</th>
                                <th>Полная стоимость</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var service in orderModel.OrderServicesDto)
                            {
                                <tr>
                                    <td>@GetServiceName(service.ServiceId)</td>
                                    <td>
                                        <InputNumber class="form-control table-input" 
                                                    @bind-Value="@service.Price" 
                                                    @bind-Value:after="() => UpdateServiceTotal(service)" />
                                    </td>
                                    <td>
                                        <InputNumber class="form-control table-input" 
                                                    @bind-Value="@service.TotalVolume" 
                                                    @bind-Value:after="() => UpdateServiceTotal(service)" />
                                    </td>
                                    <td>
                                        <input type="text" 
                                               class="form-control table-input" 
                                               value="@(CalculateTotalCost(service).ToString("C"))" 
                                               readonly />
                                    </td>
                                    <td>
                                        <button type="button" class="btn-remove-compact" @onclick="() => RemoveService(service)">
                                            &times;
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="empty-services-compact">
                        <p>На данный момент нет выбранных услуг</p>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    @errorMessage
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Cancel">Отмена</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner"></span>
                        <text>Создание...</text>
                    }
                    else
                    {
                        <text>Создать заявку</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <ServiceDialog IsVisible="@showServiceDialog"
                   AvailableServices="@availableServices"
                   OnClose="@(() => showServiceDialog = false)" 
                   OnServiceAdded="@AddService" />

    <EmployeeDialog IsVisible="@showEmployeeDialog"
                    OnClose="@(() => showEmployeeDialog = false)"
                    AvailableEmployees="@availableEmployees"
                    InitialEmployeeIds="@orderModel.OrderEmployeeIds"
                    OnSelectionChanged="HandleEmployeeSelectionChanged" />

    <CarDialog IsVisible="@showCarDialog"
               OnClose="@(() => showCarDialog = false)"
               AvailableCars="@availableCars"
               InitialCarIds="@orderModel.OrderCarIds"
               OnSelectionChanged="HandleCarSelectionChanged" />

@code {
    private OrderDto orderModel = new();
    private List<EmployeeDto> availableEmployees = new();
    private List<CarDto> availableCars = new();
    private List<ServiceDto> availableServices = new();
    private bool showServiceDialog = false;
    private bool showEmployeeDialog = false;
    private bool showCarDialog = false;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var createOrderParameters = await ApiService.GetCreateOrderParameters();
            if (createOrderParameters != null)
            {
                availableEmployees = createOrderParameters.EmployeeDtos ?? new List<EmployeeDto>();
                availableCars = createOrderParameters.CarDtos ?? new List<CarDto>();
                availableServices = createOrderParameters.ServiceDtos ?? new List<ServiceDto>();
            }
            else
            {
                availableEmployees = new List<EmployeeDto>();
                availableCars = new List<CarDto>();
                availableServices = new List<ServiceDto>();
            }
        }
        catch
        {
            errorMessage = "Failed to load reference data.";
            availableEmployees = new List<EmployeeDto>();
            availableCars = new List<CarDto>();
        }
    }

    private void ShowServiceDialog()
    {
        showServiceDialog = true;
    }

    private void ShowEmployeeDialog()
    {
        showEmployeeDialog = true;
    }

    private void ShowCarDialog()
    {
        showCarDialog = true;
    }

    private void AddService(OrderServicesDto service)
    {
        // Convert total price to unit price for editing
        // Note: ServiceDialog stores total price (unit price * volume) in Price field
        // We convert it to unit price for table editing
        if (service.TotalVolume > 0 && service.Price > 0)
        {
            service.Price = service.Price / (decimal)service.TotalVolume;
        }
        orderModel.OrderServicesDto.Add(service);
    }

    private void UpdateServiceTotal(OrderServicesDto service)
    {
        // Force UI update by triggering StateHasChanged
        StateHasChanged();
    }

    private void RemoveService(OrderServicesDto service)
    {
        orderModel.OrderServicesDto.Remove(service);
    }

    private void HandleEmployeeSelectionChanged(List<int> employeeIds)
    {
        orderModel.OrderEmployeeIds = employeeIds;
    }

    private void HandleCarSelectionChanged(List<int> carIds)
    {
        orderModel.OrderCarIds = carIds;
    }

    private void RemoveEmployee(int employeeId)
    {
        orderModel.OrderEmployeeIds.Remove(employeeId);
    }

    private void RemoveCar(int carId)
    {
        orderModel.OrderCarIds.Remove(carId);
    }

    private string GetServiceName(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Name ?? "Unknown Service";
    }

    private string GetServiceUnit(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Measure ?? "";
    }

    private decimal GetServiceMinPrice(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinPrice ?? 0;
    }
    
    private double GetServiceMinVolume(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.MinVolume ?? 0;
    }

    private decimal CalculateTotalCost(OrderServicesDto service)
    {
        return service.Price * (decimal)service.TotalVolume;
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            var success = true; //await ApiService.CreateApplicationAsync(applicationModel);

            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Failed to create application. Please try again.";
            }
        }
        catch
        {
            errorMessage = "An error occurred while creating the application. Please try again.";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

}
