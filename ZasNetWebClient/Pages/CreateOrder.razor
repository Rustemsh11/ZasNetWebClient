@page "/create-order"
@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@using ZasNetWebClient.Components
@inject ApiService ApiService
@inject NavigationManager Navigation

<PageTitle>Создание заявки - ZasNet</PageTitle>

    <div class="page-header-compact">
        <h1>Создание новой заявки</h1>
    </div>

    <div class="create-form-container-compact">
        <EditForm Model="@orderModel" OnValidSubmit="@HandleSubmit">
            <DataAnnotationsValidator />
            
            <div class="form-section">
                <h3>Информация клиента</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client">Название клиента</label>
                        <InputText id="client" @bind-Value="orderModel.Client" class="form-control" placeholder="введите клиента" />
                        <ValidationMessage For="@(() => orderModel.Client)" />
                    </div>
                    <div class="form-group">
                        <label for="date">Дата</label>
                        <InputDate id="date" @bind-Value="orderModel.Date" class="form-control" />
                        <ValidationMessage For="@(() => orderModel.Date)" />
                    </div>
                    <div class="form-group">
                        <label for="payment">Вид оплаты</label>
                        <InputSelect id="payment" @bind-Value="orderModel.PaymentType" class="form-control">
                            <option value="@PaymentType.Cash">Наличные</option>
                            <option value="@PaymentType.Card">Карта</option>
                            <option value="@PaymentType.Electronic">СБП</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => orderModel.PaymentType)" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">Город</label>
                        <InputText id="city" @bind-Value="orderModel.AddressCity" class="form-control" placeholder="введите город"/>
                        <ValidationMessage For="@(() => orderModel.AddressCity)" />
                    </div>
                    <div class="form-group">
                        <label for="street">Улица</label>
                        <InputText id="street" @bind-Value="orderModel.AddressStreet" class="form-control" placeholder="введите улицу" />
                        <ValidationMessage For="@(() => orderModel.AddressStreet)" />
                    </div>
                    <div class="form-group">
                        <label for="number">Номер дома</label>
                        <InputText id="number" @bind-Value="orderModel.AddressNumber" class="form-control" placeholder="введите номер дома" />
                        <ValidationMessage For="@(() => orderModel.AddressNumber)" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Доп. информация</label>
                    <InputTextArea id="description" @bind-Value="orderModel.Description" class="form-control" placeholder="введите доп. информацию" rows="1" />
                </div>
            </div>

            <div class="form-section">
                <h3>Информация заявки</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Общая стоимость заявки</label>
                        <InputNumber id="price" @bind-Value="orderModel.OrderPriceAmount" class="form-control" />
                    <ValidationMessage For="@(() => orderModel.OrderPriceAmount)" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Информация работников</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="employees">Ответственный сотрудник</label>
                        <select id="employees" @onchange="OnEmployeesChanged" class="form-control" multiple>
                            @foreach (var employee in availableEmployees)
                            {
                                var isSelected = orderModel.OrderEmployeeIds.Contains(employee.Id);
                                @if (isSelected)
                                {
                                    <option value="@employee.Id" selected>@employee.Name</option>
                                }
                                else
                                {
                                    <option value="@employee.Id">@employee.Name</option>
                                }
                            }
                        </select>
                        <small class="form-text">Нажмите Ctrl чтобы выбрать несколько сотрудников</small>
                    </div>
                    <div class="form-group">
                        <label for="cars">Выездные машины</label>
                        <select id="cars" @onchange="OnCarsChanged" class="form-control" multiple>
                            @foreach (var car in availableCars)
                            {
                                var isSelected = orderModel.OrderCarIds.Contains(car.Id);
                                @if (isSelected)
                                {
                                    <option value="@car.Id" selected>@car.Name</option>
                                }
                                else
                                {
                                    <option value="@car.Id">@car.Name</option>
                                }
                            }
                        </select>
                    <small class="form-text">Нажмите Ctrl чтобы выбрать несколько машин</small>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="services-header">
                    <h3>Услуги</h3>
                    <button type="button" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; text-align: left;" @onclick="ShowServiceDialog">
                        <span style="font-size: 0.75rem; line-height: 1;">+</span> Добавить
                    </button>
                </div>
                
                @if (orderModel.OrderServicesDto.Any())
                {
                    <div class="services-grid-compact">
                    @foreach (var service in orderModel.OrderServicesDto)
                    {
                        <div class="service-item-compact">
                            <span class="service-name-compact">@GetServiceName(service.ServiceId)</span>
                            <span class="service-price-compact">@service.Price.ToString("C")</span>
                            <button type="button" class="btn-remove-compact" @onclick="() => RemoveService(service)">
                                &times;
                            </button>
                        </div>
                    }
                    </div>
                }
                else
                {
                    <div class="empty-services-compact">
                        <p>На данный момент нет выбранных услуг</p>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    @errorMessage
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Cancel">Отмена</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner"></span>
                        <text>Создание...</text>
                    }
                    else
                    {
                        <text>Создать заявку</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <ServiceDialog IsVisible="@showServiceDialog" 
                   OnClose="@(() => showServiceDialog = false)" 
                   OnServiceAdded="@AddService" />

@code {
    private OrderDto orderModel = new();
    private List<EmployeeDto> availableEmployees = new();
    private List<CarDto> availableCars = new();
    private List<ServiceDto> availableServices = new();
    private bool showServiceDialog = false;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var createOrderParameters = await ApiService.GetCreateOrderParameters();
            if (createOrderParameters != null)
            {
                availableEmployees = createOrderParameters.EmployeeDtos ?? new List<EmployeeDto>();
                availableCars = createOrderParameters.CarDtos ?? new List<CarDto>();
            }
            else
            {
                availableEmployees = new List<EmployeeDto>();
                availableCars = new List<CarDto>();
            }
        }
        catch
        {
            errorMessage = "Failed to load reference data.";
            availableEmployees = new List<EmployeeDto>();
            availableCars = new List<CarDto>();
        }
    }

    private void ShowServiceDialog()
    {
        showServiceDialog = true;
    }

    private void AddService(OrderServicesDto service)
    {
        orderModel.OrderServicesDto.Add(service);
    }

    private void RemoveService(OrderServicesDto service)
    {
        orderModel.OrderServicesDto.Remove(service);
    }

    private string GetServiceName(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Name ?? "Unknown Service";
    }

    private string GetServiceUnit(int serviceId)
    {
        return availableServices.FirstOrDefault(s => s.Id == serviceId)?.Unit ?? "";
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            var success = true; //await ApiService.CreateApplicationAsync(applicationModel);

            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Failed to create application. Please try again.";
            }
        }
        catch
        {
            errorMessage = "An error occurred while creating the application. Please try again.";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private void OnEmployeesChanged(ChangeEventArgs e)
    {
        // Note: ChangeEventArgs.Value doesn't work reliably with multiple select in Blazor WebAssembly
        // The selections are maintained via the selected attribute on options
    }

    private void OnCarsChanged(ChangeEventArgs e)
    {
        // Note: ChangeEventArgs.Value doesn't work reliably with multiple select in Blazor WebAssembly
        // The selections are maintained via the selected attribute on options
    }
}
