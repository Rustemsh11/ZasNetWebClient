@using ZasNetWebClient.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider _authenticationStateProvider
@inherits LayoutComponentBase

<AuthorizeView>
    <div class="app-container">
        <nav class="navbar">
            <div class="navbar-brand">
                <h2>ZasNet</h2>
            </div>

            <button class="navbar-toggle" @onclick="ToggleMobileMenu" aria-label="Открыть меню">
                <span class="hamburger-icon"></span>
                <span class="hamburger-icon"></span>
                <span class="hamburger-icon"></span>
            </button>

            <div class="navbar-menu @(isMobileMenuOpen ? "active" : "")">
                <a href="/" class="nav-link @GetActiveClass("/")" @onclick="CloseMobileMenu">Все заявки</a>
                <a href="/my-orders" class="nav-link @GetActiveClass("/my-orders")" @onclick="CloseMobileMenu">Мои заявки</a>
                <a href="/employeeEarnings" class="nav-link @GetActiveClass("/employeeEarnings")" @onclick="CloseMobileMenu">Заработки сотрудников</a>
                <a href="/dispetcherEarnings" class="nav-link @GetActiveClass("/dispetcherEarnings")" @onclick="CloseMobileMenu">Заработки диспетчеров</a>
                <a href="/structure" class="nav-link @GetActiveClass("/structure")" @onclick="CloseMobileMenu">Структура</a>
                <a href="/profile" class="nav-link @GetActiveClass("/profile")" @onclick="CloseMobileMenu">Личные данные</a>
            </div>

            <div class="navbar-user">
                <span class="user-info">@CurrentUser</span>
                <button class="btn-logout" @onclick="Logout">Выйти</button>
            </div>
        </nav>

        @if (isMobileMenuOpen)
        {
            <div class="mobile-menu-overlay" @onclick="CloseMobileMenu"></div>
        }

        <main class="main-content">
            @Body
        </main>
    </div>
</AuthorizeView>

@code {
    [CascadingParameter]
    public Task<AuthenticationState>? AuthenticationState { get; set; }
    public string CurrentUser{ get; set; }
    private bool isMobileMenuOpen = false;

    protected override async Task OnParametersSetAsync()
    {
        var state = await AuthenticationState;
        if (state != null)
        {
            if (!state.User.Identity.IsAuthenticated)
            {
                Navigation.NavigateTo("/login");
            }
            else
            {
                CurrentUser = state.User.Identity.Name;
            }
        }
    }

    private async Task Logout()
    {
        await((IdentityAuthenticationStateProvider)_authenticationStateProvider).MarkLogouted();
    }

    private string GetActiveClass(string path)
    {
        return Navigation.Uri.EndsWith(path) ? "active" : "";
    }

    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
    }

    private void CloseMobileMenu()
    {
        isMobileMenuOpen = false;
    }
}
