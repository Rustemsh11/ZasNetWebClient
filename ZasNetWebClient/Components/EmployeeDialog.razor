@using ZasNetWebClient.Models

<div class="service-dialog @(IsVisible ? "visible" : "")">
    <div class="dialog-overlay" @onclick="Close"></div>
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>Выбор работников</h3>
            <button class="btn-close" @onclick="Close">&times;</button>
        </div>
        
        <div class="dialog-body">
            <div class="form-group">
                <label for="employee-search">Поиск работников</label>
                <InputText id="employee-search" @bind-Value="employeeSearchQuery" @oninput="OnEmployeeSearchChanged" 
                           class="form-control search-input" placeholder="Введите имя для поиска" />
            </div>
            <div class="checkbox-list-container">
                <div class="checkbox-list">
                    @foreach (var employee in filteredEmployees)
                    {
                        <div class="checkbox-item">
                            <label class="checkbox-label">
                                <input type="checkbox" 
                                       checked="@selectedEmployeeIds.Contains(employee.Id)"
                                       @onchange="@((ChangeEventArgs e) => ToggleEmployee(employee.Id, e.Value?.ToString() == "True"))" />
                                <span>@employee.Name</span>
                            </label>
                        </div>
                    }
                    @if (!filteredEmployees.Any())
                    {
                        <div class="empty-list-message">Работники не найдены</div>
                    }
                </div>
            </div>

            <div class="dialog-actions">
                <button type="button" class="btn-secondary" @onclick="Close">Отмена</button>
                <button type="button" class="btn-primary" @onclick="HandleSubmit">Сохранить</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public List<EmployeeDto> AvailableEmployees { get; set; } = new();
    [Parameter] public List<int> InitialEmployeeIds { get; set; } = new();
    [Parameter] public EventCallback<List<int>> OnSelectionChanged { get; set; }

    private string employeeSearchQuery = string.Empty;
    private List<EmployeeDto> filteredEmployees = new();
    private HashSet<int> selectedEmployeeIds = new();

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (IsVisible)
        {
            selectedEmployeeIds = InitialEmployeeIds.ToHashSet();
            UpdateFilteredList();
        }
    }

    private void OnEmployeeSearchChanged(ChangeEventArgs e)
    {
        employeeSearchQuery = e.Value?.ToString() ?? string.Empty;
        UpdateFilteredList();
    }

    private void UpdateFilteredList()
    {
        if (string.IsNullOrWhiteSpace(employeeSearchQuery))
        {
            filteredEmployees = AvailableEmployees.ToList();
        }
        else
        {
            var query = employeeSearchQuery.ToLowerInvariant();
            filteredEmployees = AvailableEmployees
                .Where(e => e.Name.ToLowerInvariant().Contains(query))
                .ToList();
        }
    }

    private void ToggleEmployee(int employeeId, bool isChecked)
    {
        if (isChecked)
        {
            selectedEmployeeIds.Add(employeeId);
        }
        else
        {
            selectedEmployeeIds.Remove(employeeId);
        }
    }

    private async Task HandleSubmit()
    {
        var employeeIds = selectedEmployeeIds.ToList();
        await OnSelectionChanged.InvokeAsync(employeeIds);
        await Close();
    }

    private async Task Close()
    {
        employeeSearchQuery = string.Empty;
        await OnClose.InvokeAsync();
    }
}

