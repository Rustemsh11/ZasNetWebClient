@using ZasNetWebClient.Models
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-nav">
            <button class="btn-nav" @onclick="PreviousDay" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <h2 class="calendar-title">@CurrentDate.ToString("dd MMMM yyyy")</h2>
            <button class="btn-nav" @onclick="NextDay" title="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            <button class="btn-today" @onclick="GoToToday">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="btn-date" @onclick="ShowDatePicker">–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–∞—Ç–µ</button>
        </div>
    </div>

    @if (showDatePicker)
    {
        <div class="date-picker-overlay" @onclick="HideDatePicker">
            <div class="date-picker" @onclick:stopPropagation="true">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
                <InputDate @bind-Value="selectedDate" class="date-input" />
                <div class="date-picker-buttons">
                    <button class="btn-primary" @onclick="GoToSelectedDate">–ü–µ—Ä–µ–π—Ç–∏</button>
                    <button class="btn-secondary" @onclick="HideDatePicker">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    }

    <!-- View Toggle -->
    <div class="results-summary">
        <div class="results-info">
            <span>–ù–∞–π–¥–µ–Ω–æ –∑–∞—è–≤–æ–∫: <strong>@dayOrders.Count</strong></span>
        </div>
        <div class="view-toggle">
            <button class="view-toggle-btn @(viewMode == ViewMode.Calendar ? "active" : "")" 
                    @onclick="() => SetViewMode(ViewMode.Calendar)"
                    title="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
                <span class="icon">üìÖ</span>
            </button>
            <button class="view-toggle-btn @(viewMode == ViewMode.Cards ? "active" : "")" 
                    @onclick="() => SetViewMode(ViewMode.Cards)"
                    title="–ö–∞—Ä—Ç–æ—á–∫–∏">
                <span class="icon">‚äû</span>
            </button>
            <button class="view-toggle-btn @(viewMode == ViewMode.List ? "active" : "")" 
                    @onclick="() => SetViewMode(ViewMode.List)"
                    title="–°–ø–∏—Å–æ–∫">
                <span class="icon">‚ò∞</span>
            </button>
        </div>
    </div>

    @if (viewMode == ViewMode.Calendar)
    {
        <div class="calendar-timeline" @ref="timelineContainer">
        <div class="calendar-timeline-header">
            <div class="car-header">–ú–∞—à–∏–Ω–∞</div>
            <div class="hours-header" @ref="hoursHeader">
                @for (int hour = 0; hour <= 24; hour++)
                {
                    <div class="hour-cell">@hour</div>
                }
            </div>
        </div>
        <div class="calendar-timeline-body">
            @foreach (var carGroup in carGroups)
            {
                <div class="car-row">
                    <div class="car-name">@carGroup.CarName</div>
                    <div class="hours-row">
                        @for (int hour = 0; hour <= 24; hour++)
                        {
                            <div class="hour-cell" data-hour="@hour"></div>
                        }
                        @foreach (var order in carGroup.Orders)
                        {
                            <div class="order-block" 
                                 style="@(GetOrderStyle(order))"
                                 title="@GetOrderTooltip(order)"
                                 @ondblclick="@(() => OpenOrder(order.Id))">
                                <div class="order-content">
                                    <div class="order-time">@GetOrderTimeRange(order)</div>
                                    <div class="order-client">@order.Client</div>
                                    @if (!string.IsNullOrEmpty(order.Address))
                                    {
                                        <div class="order-address">@order.Address</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
    }
    else if (viewMode == ViewMode.Cards)
    {
        @if (dayOrders.Count == 0)
        {
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <h3>–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>
            </div>
        }
        else
        {
            <div class="orders-list">
                @foreach (var order in dayOrders.OrderBy(o => o.DateStart))
                {
                    <div class="order-card" @ondblclick="() => OpenOrder(order.Id)">
                        <div class="order-card-header">
                            <div class="order-id">
                                <span class="order-label">–ó–∞—è–≤–∫–∞</span>
                                <span class="order-number">#@order.Id</span>
                            </div>
                            <div class="order-status status-@order.Status.ToString().ToLower()">
                                @GetStatusName(order.Status)
                            </div>
                        </div>

                        <div class="order-card-body">
                            <div class="order-info-row">
                                <div class="order-info-item">
                                    <span class="info-label">–ö–ª–∏–µ–Ω—Ç:</span>
                                    <span class="info-value">@order.Client</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="info-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</span>
                                    <span class="info-value">@order.DateStart.ToString("dd.MM.yyyy HH:mm")</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="info-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</span>
                                    <span class="info-value">@(order.DateEnd?.ToString("dd.MM.yyyy HH:mm") ?? "–ù–µ —É–∫–∞–∑–∞–Ω–∞")</span>
                                </div>
                            </div>

                            <div class="order-info-row">
                                <div class="order-info-item">
                                    <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                    <span class="info-value">@(order.Address ?? "–ù–µ —É–∫–∞–∑–∞–Ω")</span>
                                </div>
                            </div>

                            @if (order.CarIds != null && order.CarIds.Any())
                            {
                                <div class="order-services">
                                    <span class="info-label">–ú–∞—à–∏–Ω—ã:</span>
                                    <div class="services-tags">
                                        @foreach (var carId in order.CarIds)
                                        {
                                            var car = AllCars?.FirstOrDefault(c => c.Id == carId);
                                            <span class="service-tag">
                                                @(car?.Name ?? $"–ú–∞—à–∏–Ω–∞ #{carId}")
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="order-card-footer">
                            <div class="footer-actions">
                                <button class="btn-primary btn-compact" @onclick="() => OpenOrder(order.Id)">
                                    –û—Ç–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                            <span class="order-hint">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è</span>
                        </div>
                    </div>
                }
            </div>
        }
    }
    else if (viewMode == ViewMode.List)
    {
        @if (dayOrders.Count == 0)
        {
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <h3>–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>
            </div>
        }
        else
        {
            <div class="earnings-table-container">
                <table class="earnings-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–ê–¥—Ä–µ—Å</th>
                            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ú–∞—à–∏–Ω—ã</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in dayOrders.OrderBy(o => o.DateStart))
                        {
                            <tr class="earning-row" @ondblclick="() => OpenOrder(order.Id)">
                                <td class="order-id-cell">
                                    <strong>#@order.Id</strong>
                                </td>
                                <td class="client-cell">@order.Client</td>
                                <td class="address-cell">@(order.Address ?? "–ù–µ —É–∫–∞–∑–∞–Ω")</td>
                                <td class="date-cell">@order.DateStart.ToString("dd.MM.yyyy HH:mm")</td>
                                <td class="date-cell">@(order.DateEnd?.ToString("dd.MM.yyyy HH:mm") ?? "–ù–µ —É–∫–∞–∑–∞–Ω–∞")</td>
                                <td class="status-cell">
                                    <span class="order-status status-@order.Status.ToString().ToLower()">
                                        @GetStatusName(order.Status)
                                    </span>
                                </td>
                                <td class="services-cell">
                                    @if (order.CarIds != null && order.CarIds.Any())
                                    {
                                        <div class="services-tags-compact">
                                            @foreach (var carId in order.CarIds.Take(2))
                                            {
                                                var car = AllCars?.FirstOrDefault(c => c.Id == carId);
                                                <span class="service-tag-small">@(car?.Name ?? $"–ú–∞—à–∏–Ω–∞ #{carId}")</span>
                                            }
                                            @if (order.CarIds.Count > 2)
                                            {
                                                <span class="service-tag-small more">+@(order.CarIds.Count - 2)</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="empty-description">‚Äî</span>
                                    }
                                </td>
                                <td class="action-cell">
                                    <div class="action-buttons">
                                        <button class="btn-primary btn-compact" @onclick="() => OpenOrder(order.Id)">
                                            –û—Ç–∫—Ä—ã—Ç—å
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public List<Order> Orders { get; set; } = new();

    [Parameter]
    public List<CarDto> AllCars { get; set; } = new();

    private DateTime CurrentDate = DateTime.Today;
    private bool showDatePicker = false;
    private DateTime selectedDate = DateTime.Today;

    private List<CarOrderGroup> carGroups = new();
    private ElementReference timelineContainer;
    private ElementReference hoursHeader;
    private bool shouldScrollToHour8 = true;
    private List<Order> dayOrders = new();
    private ViewMode viewMode = ViewMode.Calendar;

    private enum ViewMode
    {
        Calendar,
        Cards,
        List
    }

    protected override void OnParametersSet()
    {
        BuildCalendar();
        shouldScrollToHour8 = true;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // if (shouldScrollToHour8)
        // {
        //     // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        //     await Task.Delay(100);
        //     await ScrollToHour(6);
        //     // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        //     await Task.Delay(100);
        //     await ScrollToHour(6);
        //     shouldScrollToHour8 = false;
        // }
        
        // // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ —Ç–∞–∫–∂–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ 8 —á–∞—Å—É
        // if (firstRender)
        // {
        //     await Task.Delay(200);
        //     await ScrollToHour(6);
        // }
    }

    private void BuildCalendar()
    {
        carGroups.Clear();

        // Get orders for the current date
        dayOrders = Orders.Where(o => o.DateStart.Date == CurrentDate.Date).ToList();

        // Group orders by car ID
        var ordersByCarId = new Dictionary<int, List<Order>>();
        var ordersWithoutCar = new List<Order>();
        
        foreach (var order in dayOrders)
        {
            if (order.CarIds != null && order.CarIds.Count > 0)
            {
                // Add order to each car it's assigned to
                foreach (var carId in order.CarIds)
                {
                    if (!ordersByCarId.ContainsKey(carId))
                    {
                        ordersByCarId[carId] = new List<Order>();
                    }
                    ordersByCarId[carId].Add(order);
                }
            }
            else
            {
                // Order without cars
                ordersWithoutCar.Add(order);
            }
        }

        // Sort orders within each car group
        foreach (var carId in ordersByCarId.Keys.ToList())
        {
            ordersByCarId[carId] = ordersByCarId[carId].OrderBy(o => o.DateStart).ToList();
        }
        ordersWithoutCar = ordersWithoutCar.OrderBy(o => o.DateStart).ToList();

        // Create groups for all cars from AllCars
        if (AllCars != null && AllCars.Count > 0)
        {
            foreach (var car in AllCars)
            {
                var carOrders = ordersByCarId.ContainsKey(car.Id) 
                    ? ordersByCarId[car.Id] 
                    : new List<Order>();
                
                carGroups.Add(new CarOrderGroup
                {
                    CarName = car.Name,
                    Orders = carOrders
                });
            }
        }

        // Add cars from orders that are not in AllCars (by ID)
        foreach (var carId in ordersByCarId.Keys)
        {
            if (AllCars == null || !AllCars.Any(c => c.Id == carId))
            {
                // Car ID exists in orders but not in AllCars - use ID as name
                carGroups.Add(new CarOrderGroup
                {
                    CarName = $"–ú–∞—à–∏–Ω–∞ #{carId}",
                    Orders = ordersByCarId[carId]
                });
            }
        }

        // Add orders without cars
        if (ordersWithoutCar.Count > 0)
        {
            carGroups.Add(new CarOrderGroup
            {
                CarName = "–ë–µ–∑ –º–∞—à–∏–Ω—ã",
                Orders = ordersWithoutCar
            });
        }

        // If no cars at all, show a message
        if (carGroups.Count == 0)
        {
            carGroups.Add(new CarOrderGroup
            {
                CarName = "–ù–µ—Ç –º–∞—à–∏–Ω",
                Orders = new List<Order>()
            });
        }
    }

    private void PreviousDay()
    {
        CurrentDate = CurrentDate.AddDays(-1);
        BuildCalendar();
        shouldScrollToHour8 = true;
        StateHasChanged();
    }

    private void NextDay()
    {
        CurrentDate = CurrentDate.AddDays(1);
        BuildCalendar();
        shouldScrollToHour8 = true;
        StateHasChanged();
    }

    private void GoToToday()
    {
        CurrentDate = DateTime.Today;
        BuildCalendar();
        shouldScrollToHour8 = true;
        StateHasChanged();
    }

    private void ShowDatePicker()
    {
        selectedDate = CurrentDate;
        showDatePicker = true;
        StateHasChanged();
    }

    private void HideDatePicker()
    {
        showDatePicker = false;
        StateHasChanged();
    }

    private void GoToSelectedDate()
    {
        CurrentDate = selectedDate.Date;
        BuildCalendar();
        HideDatePicker();
        shouldScrollToHour8 = true;
        StateHasChanged();
    }

    private async Task ScrollToHour(int hour)
    {
        try
        {
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ–∑–∏—Ü–∏–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∞—Å–∞
            // –ö–∞–∂–¥—ã–π —á–∞—Å –∑–∞–Ω–∏–º–∞–µ—Ç 1/25 –æ—Ç –æ–±—â–µ–π —à–∏—Ä–∏–Ω—ã (25 —Å—Ç–æ–ª–±—Ü–æ–≤: 0-24)
            // –ü–æ–∑–∏—Ü–∏—è 8 —á–∞—Å–æ–≤ = 8/25 = 32% –æ—Ç –æ–±—â–µ–π —à–∏—Ä–∏–Ω—ã
            var scrollPercent = (hour / 25.0) * 100;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä timeline, —Ç–∞–∫ –∫–∞–∫ —É –Ω–µ–≥–æ overflow-x: auto
            await JSRuntime.InvokeVoidAsync("scrollToHour", timelineContainer, scrollPercent);
        }
        catch
        {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        }
    }

    private void OpenOrder(int orderId)
    {
        if (orderId > 0)
        {
            Navigation.NavigateTo($"/order/{orderId}");
        }
    }

    private string GetOrderStyle(Order order)
    {
        var startHour = order.DateStart.Hour;
        var startMinute = order.DateStart.Minute;
        var startPosition = startHour + (startMinute / 60.0);

        var endHour = order.DateEnd?.Hour ?? order.DateStart.AddHours(1).Hour;
        var endMinute = order.DateEnd?.Minute ?? order.DateStart.AddMinutes(60).Minute;
        var endPosition = endHour + (endMinute / 60.0);

        var duration = endPosition - startPosition;
        if (duration <= 0) duration = 1; // Minimum 1 hour

        // –£ –Ω–∞—Å 25 —Å—Ç–æ–ª–±—Ü–æ–≤ (0-24), –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∏–º –Ω–∞ 25
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º InvariantCulture –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª
        var leftPercent = (startPosition / 25.0) * 100;
        var widthPercent = (duration / 25.0) * 100;

        var backgroundColor = GetStatusColor(order.Status);

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∏–ª—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º InvariantCulture –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ—á–∫–∏ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
        return string.Format(
            System.Globalization.CultureInfo.InvariantCulture,
            "left: {0:F2}%; width: {1:F2}%; background-color: {2};",
            leftPercent,
            widthPercent,
            backgroundColor
        );
    }

    private string GetOrderTimeRange(Order order)
    {
        var start = order.DateStart.ToString("HH:mm");
        if (order.DateEnd.HasValue)
        {
            var end = order.DateEnd.Value.ToString("HH:mm");
            return $"{start} - {end}";
        }
        return start;
    }

    private string GetOrderTooltip(Order order)
    {
        var tooltip = $"{order.Client}\n";
        if (!string.IsNullOrEmpty(order.Address))
        {
            tooltip += $"–ê–¥—Ä–µ—Å: {order.Address}\n";
        }
        return tooltip;
    }

    private string GetStatusColor(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Created => "#3498db",
            OrderStatus.ApprovedWithEmployers => "#007bff",
            OrderStatus.Processing => "#fd7e14",
            OrderStatus.Finished => "#28a745",
            OrderStatus.CreatingInvoice => "#6f42c1",
            OrderStatus.SendingPayment => "#17a2b8",
            OrderStatus.AwaitingPayment => "#ffc107",
            OrderStatus.Closed => "#6c757d",
            _ => "#f5f5f5"
        };
    }

    private string GetStatusName(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Created => "–°–æ–∑–¥–∞–Ω–∞",
            OrderStatus.ApprovedWithEmployers => "–û–¥–æ–±—Ä–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏",
            OrderStatus.Processing => "–í —Ä–∞–±–æ—Ç–µ",
            OrderStatus.Finished => "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
            OrderStatus.CreatingInvoice => "–°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞",
            OrderStatus.SendingPayment => "–û—Ç–ø—Ä–∞–≤–∫–∞ —Å—á–µ—Ç–∞",
            OrderStatus.AwaitingPayment => "–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã",
            OrderStatus.Closed => "–ó–∞–∫—Ä—ã—Ç–∞",
            _ => "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        };
    }

    private void SetViewMode(ViewMode mode)
    {
        viewMode = mode;
        StateHasChanged();
    }

    private class CarOrderGroup
    {
        public string CarName { get; set; } = string.Empty;
        public List<Order> Orders { get; set; } = new();
    }
}
