@using ZasNetWebClient.Models

<div class="service-dialog @(IsVisible ? "visible" : "")">
    <div class="dialog-overlay" @onclick="Close"></div>
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>Выбор машин</h3>
            <button class="btn-close" @onclick="Close">&times;</button>
        </div>
        
        <div class="dialog-body">
            <div class="form-group">
                <label for="car-search">Поиск машин</label>
                <InputText id="car-search" @bind-Value="carSearchQuery" @oninput="OnCarSearchChanged" 
                           class="form-control search-input" placeholder="Введите название для поиска" />
            </div>
            <div class="checkbox-list-container">
                <div class="checkbox-list">
                    @foreach (var car in filteredCars)
                    {
                        <div class="checkbox-item">
                            <label class="checkbox-label">
                                <input type="checkbox" 
                                       checked="@selectedCarIds.Contains(car.Id)"
                                       @onchange="@((ChangeEventArgs e) => ToggleCar(car.Id, e.Value?.ToString() == "True"))" />
                                <span>@car.Name</span>
                            </label>
                        </div>
                    }
                    @if (!filteredCars.Any())
                    {
                        <div class="empty-list-message">Машины не найдены</div>
                    }
                </div>
            </div>

            <div class="dialog-actions">
                <button type="button" class="btn-secondary" @onclick="Close">Отмена</button>
                <button type="button" class="btn-primary" @onclick="HandleSubmit">Сохранить</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public List<CarDto> AvailableCars { get; set; } = new();
    [Parameter] public List<int> InitialCarIds { get; set; } = new();
    [Parameter] public EventCallback<List<int>> OnSelectionChanged { get; set; }

    private string carSearchQuery = string.Empty;
    private List<CarDto> filteredCars = new();
    private HashSet<int> selectedCarIds = new();

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (IsVisible)
        {
            selectedCarIds = InitialCarIds.ToHashSet();
            UpdateFilteredList();
        }
    }

    private void OnCarSearchChanged(ChangeEventArgs e)
    {
        carSearchQuery = e.Value?.ToString() ?? string.Empty;
        UpdateFilteredList();
    }

    private void UpdateFilteredList()
    {
        if (string.IsNullOrWhiteSpace(carSearchQuery))
        {
            filteredCars = AvailableCars.ToList();
        }
        else
        {
            var query = carSearchQuery.ToLowerInvariant();
            filteredCars = AvailableCars
                .Where(c => c.Name.ToLowerInvariant().Contains(query))
                .ToList();
        }
    }

    private void ToggleCar(int carId, bool isChecked)
    {
        if (isChecked)
        {
            selectedCarIds.Add(carId);
        }
        else
        {
            selectedCarIds.Remove(carId);
        }
    }

    private async Task HandleSubmit()
    {
        var carIds = selectedCarIds.ToList();
        await OnSelectionChanged.InvokeAsync(carIds);
        await Close();
    }

    private async Task Close()
    {
        carSearchQuery = string.Empty;
        await OnClose.InvokeAsync();
    }
}

