@using ZasNetWebClient.Models
@using ZasNetWebClient.Services
@inject ApiService ApiService
@inject NotificationService NotificationService

<div class="service-dialog @(IsVisible ? "visible" : "")">
    <div class="dialog-overlay" @onclick="Close"></div>
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>Добавление услуги</h3>
            <button class="btn-close" @onclick="Close">&times;</button>
        </div>
        
        <div class="dialog-body">
            <EditForm Model="@serviceModel" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="form-group">
                    <label for="service">Услуга</label>
                    <select id="service" @bind="serviceModel.ServiceId" class="form-control" @bind:after="OnServiceChanged">
                        <option value="">Выбрать услугу</option>
                        @foreach (var service in AvailableServices)
                        {
                            <option value="@service.Id">@service.Name</option>
                        }
                    </select>
                    <ValidationMessage For="@(() => serviceModel.ServiceId)" />
                </div>

                <div class="form-group">
                    <label for="price">Цена</label>
                    <InputNumber id="price" @bind-Value="Price" class="form-control" placeholder="введите цену" />
                    <ValidationMessage For="@(() => serviceModel.Price)" />
                </div>

                <div class="form-group">
                    <label for="volume">Общий объем</label>
                    <InputNumber id="volume" @bind-Value="Volume" class="form-control" placeholder="введите объем" />
                    <ValidationMessage For="@(() => serviceModel.TotalVolume)" />
                </div>
                
                <div class="form-group">
                    <label for="measure">Ед. измерения</label>
                    <InputText id="measure" @bind-Value="Measure" class="form-control" placeholder="введите ед. измерения" />
                </div>

                <div class="dialog-actions">
                    <button type="button" class="btn-secondary" @onclick="Close">Отмена</button>
                    <button type="submit" class="btn-primary">Добавить</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<OrderServiceDto> OnServiceAdded { get; set; }
    [Parameter] public List<ServiceDto> AvailableServices { get; set; } = new();

    private OrderServiceDto serviceModel = new ();
    private string errorMessage = string.Empty;
    public decimal Price = 0;
    public double Volume = 0;
    public string Measure = "";

    protected override Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // await LoadServices();
            ResetForm();
        }

        return Task.CompletedTask;
    }

    private void OnServiceChanged()
    {
        var selectedService = AvailableServices.FirstOrDefault(s => s.Id == serviceModel.ServiceId);
        if (selectedService != null)
        {
            Price = selectedService.MinPrice;
            Measure = selectedService.Measure;
            Volume = selectedService.MinVolume;
        }
    }

    private void ResetForm()
    {
        serviceModel = new OrderServiceDto();
        errorMessage = string.Empty;
    }

    private async Task HandleSubmit()
    {
        serviceModel = new OrderServiceDto()
            {
                Price = Price * (decimal)Volume,
                TotalVolume = Volume,
                ServiceId = serviceModel.ServiceId,
            };
        if (serviceModel.ServiceId == 0)
        {
            errorMessage = "Выберите услугу";
            NotificationService.ShowError(errorMessage);
            return;
        }

        if (serviceModel.Price <= 0)
        {
            errorMessage = "Цена должна быть выше 0";
            NotificationService.ShowError(errorMessage);
            return;
        }

        if (serviceModel.TotalVolume <= 0)
        {
            errorMessage = "Общая стоимость должна быть выше 0";
            NotificationService.ShowError(errorMessage);
            return;
        }

        await OnServiceAdded.InvokeAsync(serviceModel);
        await Close();
    }

    private async Task Close()
    {
        ResetForm();
        await OnClose.InvokeAsync();
    }
}
