@inject ZasNetWebClient.Services.NotificationService NotificationService

@if (!string.IsNullOrEmpty(currentMessage))
{
    <div class="top-info-alert">
        <span class="top-info-alert-text">@currentMessage</span>
        <button type="button" class="top-info-alert-close" @onclick="Close">&times;</button>
    </div>
}

@code {
    private string? currentMessage;
    private CancellationTokenSource? _autoCloseCts;

    protected override void OnInitialized()
    {
        NotificationService.OnInfo += HandleInfo;
        NotificationService.OnClear += HandleClear;
    }

    private async void HandleInfo(string message)
    {
        // Отменяем предыдущий таймер, если он есть
        _autoCloseCts?.Cancel();
        _autoCloseCts?.Dispose();
        
        currentMessage = message;
        await InvokeAsync(StateHasChanged);

        // Запускаем новый таймер на 4 секунды
        _autoCloseCts = new CancellationTokenSource();
        try
        {
            await Task.Delay(4000, _autoCloseCts.Token);
            currentMessage = null;
            await InvokeAsync(StateHasChanged);
            NotificationService.Clear();
        }
        catch (TaskCanceledException)
        {
            // Таймер был отменен - это нормально
        }
    }

    private void HandleClear()
    {
        _autoCloseCts?.Cancel();
        currentMessage = null;
        InvokeAsync(StateHasChanged);
    }

    private void Close()
    {
        _autoCloseCts?.Cancel();
        currentMessage = null;
        NotificationService.Clear();
    }

    public void Dispose()
    {
        _autoCloseCts?.Cancel();
        _autoCloseCts?.Dispose();
        NotificationService.OnInfo -= HandleInfo;
        NotificationService.OnClear -= HandleClear;
    }
}


